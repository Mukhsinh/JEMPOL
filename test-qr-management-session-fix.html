<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Management Session Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test QR Management Session Fix</h1>
        
        <div class="section info">
            <h3>üìã Diagnosis Masalah</h3>
            <p>Halaman QR Management mengalami error 403 "Token tidak valid" meskipun session exists.</p>
            <p>Kemungkinan penyebab:</p>
            <ul>
                <li>Session tidak ter-sync antara AuthContext dan API service</li>
                <li>Token expired atau invalid</li>
                <li>RLS policies terlalu ketat</li>
                <li>Backend middleware authentication issue</li>
            </ul>
        </div>

        <div class="section">
            <h3>üîç Test Session & Authentication</h3>
            <button onclick="testCurrentSession()">Test Current Session</button>
            <button onclick="testTokenValidation()">Test Token Validation</button>
            <button onclick="testAPIEndpoints()">Test API Endpoints</button>
            <button onclick="clearAndRelogin()">Clear & Re-login</button>
        </div>

        <div class="section">
            <h3>üìä Results</h3>
            <div id="results" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://your-project.supabase.co';
        const supabaseAnonKey = 'your-anon-key';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        const API_BASE_URL = 'http://localhost:3003/api';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            results.textContent += logEntry;
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        async function testCurrentSession() {
            log('üîÑ Testing current session...');
            
            try {
                // Test Supabase session
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`‚ùå Session error: ${error.message}`, 'error');
                    return;
                }
                
                if (session) {
                    log(`‚úÖ Session exists for: ${session.user.email}`);
                    log(`üîë Token expires at: ${new Date(session.expires_at * 1000).toLocaleString()}`);
                    
                    // Test admin profile
                    const { data: admin, error: adminError } = await supabase
                        .from('admins')
                        .select('*')
                        .eq('email', session.user.email)
                        .eq('is_active', true)
                        .single();
                    
                    if (adminError) {
                        log(`‚ùå Admin profile error: ${adminError.message}`, 'error');
                    } else if (admin) {
                        log(`‚úÖ Admin profile found: ${admin.username} (${admin.role})`);
                    } else {
                        log('‚ùå Admin profile not found', 'error');
                    }
                } else {
                    log('‚ùå No session found', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Session test error: ${error.message}`, 'error');
            }
        }

        async function testTokenValidation() {
            log('üîÑ Testing token validation...');
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    log('‚ùå No session for token test', 'error');
                    return;
                }
                
                const token = session.access_token;
                log(`üîë Token length: ${token.length}`);
                
                // Test token with backend
                const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Token validation successful: ${JSON.stringify(data)}`);
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Token validation failed (${response.status}): ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Token validation error: ${error.message}`, 'error');
            }
        }

        async function testAPIEndpoints() {
            log('üîÑ Testing API endpoints...');
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    log('‚ùå No session for API test', 'error');
                    return;
                }
                
                const token = session.access_token;
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                
                // Test units endpoint
                log('üìã Testing /units endpoint...');
                const unitsResponse = await fetch(`${API_BASE_URL}/units`, { headers });
                
                if (unitsResponse.ok) {
                    const unitsData = await unitsResponse.json();
                    log(`‚úÖ Units endpoint success: ${unitsData.length || 0} units`);
                } else {
                    const unitsError = await unitsResponse.text();
                    log(`‚ùå Units endpoint failed (${unitsResponse.status}): ${unitsError}`, 'error');
                }
                
                // Test QR codes endpoint
                log('üìã Testing /qr-codes endpoint...');
                const qrResponse = await fetch(`${API_BASE_URL}/qr-codes`, { headers });
                
                if (qrResponse.ok) {
                    const qrData = await qrResponse.json();
                    log(`‚úÖ QR codes endpoint success: ${qrData.qr_codes?.length || 0} codes`);
                } else {
                    const qrError = await qrResponse.text();
                    log(`‚ùå QR codes endpoint failed (${qrResponse.status}): ${qrError}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå API endpoints test error: ${error.message}`, 'error');
            }
        }

        async function clearAndRelogin() {
            log('üîÑ Clearing session and preparing for re-login...');
            
            try {
                // Clear Supabase session
                await supabase.auth.signOut();
                
                // Clear localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('supabase') || key.includes('auth') || key.includes('admin'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                log('‚úÖ Session cleared successfully');
                log('‚ÑπÔ∏è Please login again and test QR Management page');
                
                // Redirect to login after a delay
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                
            } catch (error) {
                log(`‚ùå Clear session error: ${error.message}`, 'error');
            }
        }

        // Auto-run initial test
        window.onload = function() {
            log('üöÄ QR Management Session Fix Test Started');
            testCurrentSession();
        };
    </script>
</body>
</html>