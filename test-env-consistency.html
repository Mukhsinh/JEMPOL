<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Environment Consistency</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .result { margin-top: 10px; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Environment Consistency</h1>
        <p>Tool ini membantu memastikan environment variables konsisten antara frontend dan backend.</p>

        <div class="test-section">
            <h3>1. Test Frontend Environment</h3>
            <button onclick="testFrontendEnv()">Test Frontend Env</button>
            <div id="frontend-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. Test Backend Connection</h3>
            <button onclick="testBackendConnection()">Test Backend Connection</button>
            <div id="backend-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Supabase Connection</h3>
            <button onclick="testSupabaseConnection()">Test Supabase Connection</button>
            <div id="supabase-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Test API Endpoints</h3>
            <button onclick="testApiEndpoints()">Test API Endpoints</button>
            <div id="api-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. Environment Summary</h3>
            <button onclick="showEnvironmentSummary()">Show Environment Summary</button>
            <div id="env-summary" class="result"></div>
        </div>
    </div>

    <script>
        // Frontend Environment Test
        function testFrontendEnv() {
            const result = document.getElementById('frontend-result');
            
            const frontendEnv = {
                API_URL: import.meta?.env?.VITE_API_URL || 'Not defined',
                SUPABASE_URL: import.meta?.env?.VITE_SUPABASE_URL || 'Not defined',
                NODE_ENV: import.meta?.env?.NODE_ENV || 'Not defined'
            };

            let html = '<h4>Frontend Environment Variables:</h4>';
            html += `<p><strong>API URL:</strong> ${frontendEnv.API_URL}</p>`;
            html += `<p><strong>Supabase URL:</strong> ${frontendEnv.SUPABASE_URL}</p>`;
            html += `<p><strong>Node Environment:</strong> ${frontendEnv.NODE_ENV}</p>`;

            const isValid = frontendEnv.API_URL !== 'Not defined' && 
                           frontendEnv.SUPABASE_URL !== 'Not defined';

            result.className = `result ${isValid ? 'success' : 'error'}`;
            result.innerHTML = html;
        }

        // Backend Connection Test
        async function testBackendConnection() {
            const result = document.getElementById('backend-result');
            result.innerHTML = 'Testing backend connection...';
            
            try {
                // Try development URL first
                let apiUrl = 'http://localhost:3003/api';
                
                // If in production, use relative path
                if (window.location.hostname !== 'localhost') {
                    apiUrl = '/api';
                }

                const response = await fetch(`${apiUrl}/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `
                        <h4>‚úÖ Backend Connection Successful</h4>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <p><strong>Environment:</strong> ${data.environment}</p>
                        <p><strong>Database:</strong> ${data.database}</p>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `
                    <h4>‚ùå Backend Connection Failed</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Pastikan backend berjalan di port 3003</p>
                `;
            }
        }

        // Supabase Connection Test
        async function testSupabaseConnection() {
            const result = document.getElementById('supabase-result');
            result.innerHTML = 'Testing Supabase connection...';
            
            try {
                const supabaseUrl = import.meta?.env?.VITE_SUPABASE_URL || 'https://jxxzbdivafzzwqhagwrf.supabase.co';
                const response = await fetch(`${supabaseUrl}/rest/v1/`, {
                    headers: {
                        'apikey': import.meta?.env?.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eHpiZGl2YWZ6endxaGFnd3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MTkwNTEsImV4cCI6MjA4MDQ5NTA1MX0.ICOtGuxrD19GtawdR9JAsnFn9XsHxWkr1aHCEkgHqXg'
                    }
                });

                if (response.ok || response.status === 401) {
                    result.className = 'result success';
                    result.innerHTML = `
                        <h4>‚úÖ Supabase Connection Successful</h4>
                        <p><strong>URL:</strong> ${supabaseUrl}</p>
                        <p><strong>Status:</strong> Connected</p>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `
                    <h4>‚ùå Supabase Connection Failed</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }

        // API Endpoints Test
        async function testApiEndpoints() {
            const result = document.getElementById('api-result');
            result.innerHTML = 'Testing API endpoints...';
            
            const endpoints = [
                '/health',
                '/auth/login',
                '/complaints',
                '/users'
            ];

            let apiUrl = 'http://localhost:3003/api';
            if (window.location.hostname !== 'localhost') {
                apiUrl = '/api';
            }

            let html = '<h4>API Endpoints Test:</h4>';
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${apiUrl}${endpoint}`);
                    const status = response.ok ? '‚úÖ' : '‚ö†Ô∏è';
                    html += `<p>${status} ${endpoint} - Status: ${response.status}</p>`;
                } catch (error) {
                    html += `<p>‚ùå ${endpoint} - Error: ${error.message}</p>`;
                }
            }

            result.className = 'result warning';
            result.innerHTML = html;
        }

        // Environment Summary
        function showEnvironmentSummary() {
            const result = document.getElementById('env-summary');
            
            const isDevelopment = window.location.hostname === 'localhost';
            const currentUrl = window.location.href;
            
            let html = '<h4>Environment Summary:</h4>';
            html += `<p><strong>Current URL:</strong> ${currentUrl}</p>`;
            html += `<p><strong>Environment:</strong> ${isDevelopment ? 'Development' : 'Production'}</p>`;
            html += `<p><strong>Expected API URL:</strong> ${isDevelopment ? 'http://localhost:3003/api' : '/api'}</p>`;
            html += `<p><strong>Expected Frontend URL:</strong> ${isDevelopment ? 'http://localhost:3001' : window.location.origin}</p>`;
            
            html += '<h5>Recommendations:</h5>';
            if (isDevelopment) {
                html += '<ul>';
                html += '<li>Pastikan backend berjalan di port 3003</li>';
                html += '<li>Pastikan frontend berjalan di port 3001</li>';
                html += '<li>Gunakan file .env untuk development</li>';
                html += '</ul>';
            } else {
                html += '<ul>';
                html += '<li>Pastikan environment variables di Vercel sudah benar</li>';
                html += '<li>Gunakan file .env.production untuk production</li>';
                html += '<li>API menggunakan relative path (/api)</li>';
                html += '</ul>';
            }

            result.className = 'result success';
            result.innerHTML = html;
        }

        // Auto-run environment summary on load
        window.onload = function() {
            showEnvironmentSummary();
        };
    </script>
</body>
</html>