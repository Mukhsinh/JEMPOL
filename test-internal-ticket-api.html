<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Internal Ticket API</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    .result { margin-top: 20px; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 4px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üß™ Test Internal Ticket API</h1>
  <p>Test endpoint: <code>/api/public/internal-tickets</code></p>

  <form id="testForm">
    <label>Nama Pelapor *</label>
    <input type="text" id="reporter_name" value="Test User" required>

    <label>Email *</label>
    <input type="email" id="reporter_email" value="test@example.com" required>

    <label>Telepon</label>
    <input type="tel" id="reporter_phone" value="081234567890">

    <label>Unit ID *</label>
    <input type="text" id="unit_id" placeholder="Paste unit ID dari database" required>

    <label>Departemen</label>
    <input type="text" id="reporter_department" value="IT Department">

    <label>Jabatan</label>
    <input type="text" id="reporter_position" value="Staff IT">

    <label>Kategori</label>
    <select id="category">
      <option value="it_support">IT Support</option>
      <option value="facility">Fasilitas</option>
      <option value="equipment">Peralatan</option>
      <option value="hr">SDM</option>
      <option value="admin">Administrasi</option>
      <option value="other">Lainnya</option>
    </select>

    <label>Prioritas</label>
    <select id="priority">
      <option value="low">Rendah</option>
      <option value="medium" selected>Sedang</option>
      <option value="high">Tinggi</option>
      <option value="critical">Kritis</option>
    </select>

    <label>Judul *</label>
    <input type="text" id="title" value="Test Tiket Internal" required>

    <label>Deskripsi *</label>
    <textarea id="description" rows="4" required>Ini adalah test tiket internal untuk memverifikasi API endpoint.</textarea>

    <button type="submit">üöÄ Kirim Test Ticket</button>
  </form>

  <div id="result"></div>

  <script>
    document.getElementById('testForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<p>‚è≥ Mengirim request...</p>';
      
      const payload = {
        reporter_name: document.getElementById('reporter_name').value,
        reporter_email: document.getElementById('reporter_email').value,
        reporter_phone: document.getElementById('reporter_phone').value,
        reporter_department: document.getElementById('reporter_department').value,
        reporter_position: document.getElementById('reporter_position').value,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value,
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        unit_id: document.getElementById('unit_id').value,
        source: 'web'
      };

      console.log('üì§ Payload:', payload);

      try {
        const response = await fetch('/api/public/internal-tickets', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        console.log('üì• Response status:', response.status);
        console.log('üì• Response headers:', response.headers.get('content-type'));

        const contentType = response.headers.get('content-type');
        
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('‚ùå Non-JSON response:', text);
          throw new Error('Server mengembalikan response bukan JSON:\n' + text.substring(0, 500));
        }

        const result = await response.json();
        console.log('üì• Response data:', result);

        if (response.ok && result.success) {
          resultDiv.className = 'result success';
          resultDiv.innerHTML = `
‚úÖ BERHASIL!

Nomor Tiket: ${result.ticket_number}
Message: ${result.message}

Data lengkap:
${JSON.stringify(result, null, 2)}
          `;
        } else {
          resultDiv.className = 'result error';
          resultDiv.innerHTML = `
‚ùå GAGAL!

Status: ${response.status}
Error: ${result.error || 'Unknown error'}

Response lengkap:
${JSON.stringify(result, null, 2)}
          `;
        }
      } catch (error) {
        console.error('‚ùå Error:', error);
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
‚ùå ERROR!

${error.message}

Stack:
${error.stack || 'No stack trace'}
        `;
      }
    });

    // Load units untuk memudahkan testing
    async function loadUnits() {
      try {
        const response = await fetch('/api/public/units');
        const result = await response.json();
        const units = result.data || result;
        
        if (units.length > 0) {
          document.getElementById('unit_id').value = units[0].id;
          document.getElementById('unit_id').placeholder = `Contoh: ${units[0].id} (${units[0].name})`;
          console.log('‚úÖ Units loaded:', units.length);
        }
      } catch (error) {
        console.error('‚ùå Error loading units:', error);
      }
    }

    loadUnits();
  </script>
</body>
</html>
