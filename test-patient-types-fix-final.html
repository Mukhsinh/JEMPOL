<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Patient Types Fix Final</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-item { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Patient Types Fix Final</h1>
        
        <div class="section">
            <h3>Quick Test All</h3>
            <button onclick="runAllTests()" style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px;">
                üöÄ Run All Tests
            </button>
            <div id="overallResult"></div>
        </div>

        <div class="test-grid">
            <div class="test-item">
                <h4>1. Public Endpoint Test</h4>
                <button onclick="testPublicEndpoint()">Test Public</button>
                <div id="publicResult"></div>
            </div>

            <div class="test-item">
                <h4>2. Auth Endpoint (No Token)</h4>
                <button onclick="testAuthNoToken()">Test Auth No Token</button>
                <div id="authNoTokenResult"></div>
            </div>

            <div class="test-item">
                <h4>3. Login Test</h4>
                <input type="email" id="email" placeholder="Email" value="admin@example.com" style="width: 100%; margin: 5px 0;">
                <input type="password" id="password" placeholder="Password" value="admin123" style="width: 100%; margin: 5px 0;">
                <button onclick="testLogin()">Login</button>
                <div id="loginResult"></div>
            </div>

            <div class="test-item">
                <h4>4. Auth Endpoint (With Token)</h4>
                <button onclick="testAuthWithToken()">Test Auth With Token</button>
                <div id="authWithTokenResult"></div>
            </div>

            <div class="test-item">
                <h4>5. Direct Supabase Query</h4>
                <button onclick="testDirectSupabase()">Test Direct Query</button>
                <div id="directResult"></div>
            </div>

            <div class="test-item">
                <h4>6. Frontend Service Test</h4>
                <button onclick="testFrontendService()">Test Frontend Service</button>
                <div id="frontendResult"></div>
            </div>
        </div>

        <div class="section">
            <h3>Test Summary</h3>
            <div id="testSummary"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://jxxzbdivafzzwqhagwrf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eHpiZGl2YWZ6endxaGFnd3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MTkwNTEsImV4cCI6MjA4MDQ5NTA1MX0.ICOtGuxrD19GtawdR9JAsnFn9XsHxWkr1aHCEkgHqXg';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const API_BASE_URL = 'http://localhost:3003/api';
        let currentToken = null;
        let testResults = {};

        async function runAllTests() {
            const resultDiv = document.getElementById('overallResult');
            resultDiv.innerHTML = '<div class="info">Running all tests...</div>';
            
            testResults = {};
            
            // Run tests in sequence
            await testPublicEndpoint();
            await testAuthNoToken();
            await testLogin();
            if (currentToken) {
                await testAuthWithToken();
            }
            await testDirectSupabase();
            await testFrontendService();
            
            // Show summary
            showTestSummary();
            
            const passedTests = Object.values(testResults).filter(r => r.passed).length;
            const totalTests = Object.keys(testResults).length;
            
            if (passedTests === totalTests) {
                resultDiv.innerHTML = `<div class="success">‚úÖ All tests passed! (${passedTests}/${totalTests})</div>`;
            } else {
                resultDiv.innerHTML = `<div class="warning">‚ö†Ô∏è ${passedTests}/${totalTests} tests passed</div>`;
            }
        }

        async function testPublicEndpoint() {
            const resultDiv = document.getElementById('publicResult');
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing...</div>';

                const response = await fetch(`${API_BASE_URL}/master-data/public/patient-types`);
                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Success! Found ${data.length} records</div>`;
                    testResults.public = { passed: true, message: `${data.length} records` };
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed: ${response.status}</div>`;
                    testResults.public = { passed: false, message: `Status ${response.status}` };
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                testResults.public = { passed: false, message: error.message };
            }
        }

        async function testAuthNoToken() {
            const resultDiv = document.getElementById('authNoTokenResult');
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing...</div>';

                const response = await fetch(`${API_BASE_URL}/master-data/patient-types`);
                
                if (response.status === 401) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ Correctly requires auth</div>';
                    testResults.authNoToken = { passed: true, message: 'Requires auth' };
                } else {
                    resultDiv.innerHTML = `<div class="warning">‚ö†Ô∏è Unexpected status: ${response.status}</div>`;
                    testResults.authNoToken = { passed: false, message: `Status ${response.status}` };
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                testResults.authNoToken = { passed: false, message: error.message };
            }
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');

            try {
                resultDiv.innerHTML = '<div class="info">Logging in...</div>';

                await supabase.auth.signOut();
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Login failed: ${error.message}</div>`;
                    testResults.login = { passed: false, message: error.message };
                    return;
                }

                if (!data.user || !data.session) {
                    resultDiv.innerHTML = '<div class="error">‚ùå No user data</div>';
                    testResults.login = { passed: false, message: 'No user data' };
                    return;
                }

                currentToken = data.session.access_token;
                resultDiv.innerHTML = `<div class="success">‚úÖ Login successful! User: ${data.user.email}</div>`;
                testResults.login = { passed: true, message: data.user.email };

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                testResults.login = { passed: false, message: error.message };
            }
        }

        async function testAuthWithToken() {
            const resultDiv = document.getElementById('authWithTokenResult');
            
            if (!currentToken) {
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è No token available. Login first.</div>';
                testResults.authWithToken = { passed: false, message: 'No token' };
                return;
            }
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing...</div>';

                const response = await fetch(`${API_BASE_URL}/master-data/patient-types`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Success! Found ${data.length} records</div>`;
                    testResults.authWithToken = { passed: true, message: `${data.length} records` };
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed: ${response.status} - ${JSON.stringify(data)}</div>`;
                    testResults.authWithToken = { passed: false, message: `Status ${response.status}` };
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                testResults.authWithToken = { passed: false, message: error.message };
            }
        }

        async function testDirectSupabase() {
            const resultDiv = document.getElementById('directResult');
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing...</div>';

                const { data, error } = await supabase
                    .from('patient_types')
                    .select('*')
                    .eq('is_active', true);

                if (error) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                    testResults.direct = { passed: false, message: error.message };
                } else {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Success! Found ${data.length} records</div>`;
                    testResults.direct = { passed: true, message: `${data.length} records` };
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                testResults.direct = { passed: false, message: error.message };
            }
        }

        async function testFrontendService() {
            const resultDiv = document.getElementById('frontendResult');
            
            try {
                resultDiv.innerHTML = '<div class="info">Testing frontend service...</div>';

                // Simulate the frontend masterDataService.getPatientTypes() call
                const withPublicFallback = async (primaryEndpoint, publicEndpoint, defaultData = []) => {
                    try {
                        const headers = {};
                        if (currentToken) {
                            headers['Authorization'] = `Bearer ${currentToken}`;
                        }
                        headers['Content-Type'] = 'application/json';

                        const response = await fetch(`${API_BASE_URL}${primaryEndpoint}`, { headers });
                        if (response.ok) {
                            return await response.json();
                        }
                        throw new Error(`Primary failed: ${response.status}`);
                    } catch (error) {
                        console.warn(`Primary endpoint ${primaryEndpoint} failed, trying public fallback...`, error);
                        try {
                            const fallbackResponse = await fetch(`${API_BASE_URL}${publicEndpoint}`);
                            if (fallbackResponse.ok) {
                                return await fallbackResponse.json();
                            }
                            throw new Error(`Fallback failed: ${fallbackResponse.status}`);
                        } catch (fallbackError) {
                            console.error(`Public fallback ${publicEndpoint} also failed:`, fallbackError);
                            return defaultData;
                        }
                    }
                };

                const data = await withPublicFallback(
                    '/master-data/patient-types',
                    '/master-data/public/patient-types'
                );

                if (Array.isArray(data) && data.length > 0) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Frontend service works! Found ${data.length} records</div>`;
                    testResults.frontend = { passed: true, message: `${data.length} records` };
                } else {
                    resultDiv.innerHTML = `<div class="warning">‚ö†Ô∏è No data returned</div>`;
                    testResults.frontend = { passed: false, message: 'No data' };
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                testResults.frontend = { passed: false, message: error.message };
            }
        }

        function showTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #f8f9fa;"><th style="border: 1px solid #ddd; padding: 8px;">Test</th><th style="border: 1px solid #ddd; padding: 8px;">Status</th><th style="border: 1px solid #ddd; padding: 8px;">Message</th></tr>';
            
            for (const [testName, result] of Object.entries(testResults)) {
                const status = result.passed ? '‚úÖ Pass' : '‚ùå Fail';
                const rowClass = result.passed ? 'success' : 'error';
                html += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${testName}</td><td style="border: 1px solid #ddd; padding: 8px;">${status}</td><td style="border: 1px solid #ddd; padding: 8px;">${result.message}</td></tr>`;
            }
            
            html += '</table>';
            summaryDiv.innerHTML = html;
        }

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>