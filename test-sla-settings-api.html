<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test SLA Settings API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .priority-critical { background: #ffebee; color: #c62828; }
        .priority-high { background: #fff3e0; color: #ef6c00; }
        .priority-medium { background: #f3e5f5; color: #7b1fa2; }
        .priority-low { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test SLA Settings API</h1>
        
        <div class="section">
            <h2>1. Test Get SLA Settings</h2>
            <button class="button" onclick="testGetSLASettings()">Get All SLA Settings</button>
            <div id="getSLAResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2. Test Create SLA Setting</h2>
            <button class="button" onclick="testCreateSLASetting()">Create Test SLA Setting</button>
            <div id="createSLAResult" class="result"></div>
        </div>

        <div class="section">
            <h2>3. SLA Settings Table</h2>
            <div id="slaTable"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        
        // Get auth token from localStorage or use a test token
        function getAuthToken() {
            return localStorage.getItem('token') || 'test-token';
        }

        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            const data = await response.json();
            return { response, data };
        }

        async function testGetSLASettings() {
            const resultDiv = document.getElementById('getSLAResult');
            resultDiv.textContent = 'Loading...';
            
            try {
                const { response, data } = await apiCall('/master-data/sla-settings');
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `Success! Found ${data.length} SLA settings:\n${JSON.stringify(data, null, 2)}`;
                    displaySLATable(data);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `Error: ${response.status} - ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Network Error: ${error.message}`;
            }
        }

        async function testCreateSLASetting() {
            const resultDiv = document.getElementById('createSLAResult');
            resultDiv.textContent = 'Creating...';
            
            const testData = {
                name: 'Test SLA - ' + new Date().toLocaleTimeString(),
                priority_level: 'medium',
                response_time_hours: 2,
                resolution_time_hours: 12,
                escalation_time_hours: 24,
                business_hours_only: true,
                is_active: true
            };
            
            try {
                const { response, data } = await apiCall('/master-data/sla-settings', {
                    method: 'POST',
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `Success! Created SLA setting:\n${JSON.stringify(data, null, 2)}`;
                    // Refresh the table
                    testGetSLASettings();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `Error: ${response.status} - ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Network Error: ${error.message}`;
            }
        }

        function displaySLATable(slaSettings) {
            const tableDiv = document.getElementById('slaTable');
            
            if (!slaSettings || slaSettings.length === 0) {
                tableDiv.innerHTML = '<p>No SLA settings found.</p>';
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Unit Type</th>
                            <th>Service Category</th>
                            <th>Patient Type</th>
                            <th>Priority</th>
                            <th>Response (h)</th>
                            <th>Resolution (h)</th>
                            <th>Escalation (h)</th>
                            <th>Business Hours</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            slaSettings.forEach(sla => {
                const priorityClass = `priority-${sla.priority_level || 'medium'}`;
                tableHTML += `
                    <tr>
                        <td><strong>${sla.name}</strong></td>
                        <td>${sla.unit_types?.name || '-'}</td>
                        <td>${sla.service_categories?.name || '-'}</td>
                        <td>${sla.patient_types?.name || '-'}</td>
                        <td><span class="${priorityClass}">${sla.priority_level || 'medium'}</span></td>
                        <td>${sla.response_time_hours}</td>
                        <td>${sla.resolution_time_hours}</td>
                        <td>${sla.escalation_time_hours || '-'}</td>
                        <td>${sla.business_hours_only ? 'Yes' : 'No'}</td>
                        <td>${sla.is_active ? '✅ Active' : '❌ Inactive'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            tableDiv.innerHTML = tableHTML;
        }

        // Auto-load data when page loads
        window.onload = function() {
            testGetSLASettings();
        };
    </script>
</body>
</html>