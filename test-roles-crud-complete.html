<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Roles CRUD Complete</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .result { margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .roles-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .roles-table th, .roles-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .roles-table th { background: #f8f9fa; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; }
        .badge.active { background: #d4edda; color: #155724; }
        .badge.inactive { background: #f8d7da; color: #721c24; }
        .badge.system { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test Roles CRUD Complete</h1>
        <div id="connectionStatus" class="status disconnected">‚ùå Belum terhubung ke server</div>
        
        <div class="grid">
            <!-- Login Section -->
            <div class="section">
                <h3>üîë Authentication</h3>
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="username" value="admin">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" value="admin123">
                </div>
                <button onclick="login()">Login</button>
                <button onclick="checkConnection()">Test Connection</button>
                <div id="loginResult" class="result"></div>
            </div>

            <!-- Role Management -->
            <div class="section">
                <h3>‚ûï Create New Role</h3>
                <div class="form-group">
                    <label>Role Name:</label>
                    <input type="text" id="roleName" placeholder="e.g., Customer Service">
                </div>
                <div class="form-group">
                    <label>Role Code:</label>
                    <input type="text" id="roleCode" placeholder="e.g., CS">
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="roleDescription" placeholder="Role description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Permissions:</label>
                    <select id="permissionType">
                        <option value="specific">Specific Permissions</option>
                        <option value="all">All Permissions</option>
                    </select>
                </div>
                <button class="success" onclick="createRole()">Create Role</button>
                <div id="createResult" class="result"></div>
            </div>
        </div>

        <!-- Roles List -->
        <div class="section">
            <h3>üìã Roles Management</h3>
            <button onclick="getAllRoles()">üîÑ Refresh Roles</button>
            <button onclick="clearResults()">üßπ Clear Results</button>
            
            <div id="rolesContainer">
                <div id="rolesResult" class="result">Click "Refresh Roles" to load data...</div>
            </div>
        </div>

        <!-- Update Role -->
        <div class="section">
            <h3>‚úèÔ∏è Update Role</h3>
            <div class="form-group">
                <label>Select Role to Update:</label>
                <select id="updateRoleSelect">
                    <option value="">Select a role...</option>
                </select>
            </div>
            <div class="form-group">
                <label>New Name:</label>
                <input type="text" id="updateRoleName">
            </div>
            <div class="form-group">
                <label>New Description:</label>
                <textarea id="updateRoleDescription"></textarea>
            </div>
            <div class="form-group">
                <label>Status:</label>
                <select id="updateRoleStatus">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <button onclick="updateRole()">Update Role</button>
            <div id="updateResult" class="result"></div>
        </div>

        <!-- Delete Role -->
        <div class="section">
            <h3>üóëÔ∏è Delete Role</h3>
            <div class="form-group">
                <label>Select Role to Delete:</label>
                <select id="deleteRoleSelect">
                    <option value="">Select a role...</option>
                </select>
            </div>
            <button class="danger" onclick="deleteRole()">Delete Role</button>
            <div id="deleteResult" class="result"></div>
        </div>

        <!-- View Users by Role -->
        <div class="section">
            <h3>üë• View Users by Role</h3>
            <div class="form-group">
                <label>Select Role:</label>
                <select id="viewUsersRoleSelect">
                    <option value="">Select a role...</option>
                </select>
            </div>
            <button onclick="viewUsersByRole()">View Users</button>
            <div id="viewUsersResult" class="result"></div>
        </div>
    </div>

    <script>
        let authToken = '';
        let rolesData = [];
        const API_BASE = 'http://localhost:5000/api';

        // Check server connection
        async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                const response = await fetch(`${API_BASE}/health`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    statusDiv.className = 'status connected';
                    statusDiv.textContent = '‚úÖ Server terhubung dan berjalan normal';
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = `‚ùå Tidak dapat terhubung ke server: ${error.message}`;
            }
        }

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    authToken = result.token;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Login berhasil!\nToken: ${authToken.substring(0, 50)}...\nUser: ${result.user?.full_name || username}`;
                    
                    // Auto-load roles after successful login
                    setTimeout(getAllRoles, 500);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Login gagal: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Get all roles
        async function getAllRoles() {
            const resultDiv = document.getElementById('rolesResult');

            if (!authToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please login first';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/roles`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    rolesData = result.data || [];
                    resultDiv.className = 'result success';
                    
                    // Create table
                    let tableHTML = `
                        <h4>üìä Roles Data (${rolesData.length} roles)</h4>
                        <table class="roles-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Permissions</th>
                                    <th>Status</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    rolesData.forEach(role => {
                        const permissionCount = role.permissions?.all ? 'All Access' : 
                            Object.keys(role.permissions || {}).length + ' permissions';
                        
                        tableHTML += `
                            <tr>
                                <td><strong>${role.name}</strong></td>
                                <td><code>${role.code}</code></td>
                                <td>${role.description || '-'}</td>
                                <td>${permissionCount}</td>
                                <td><span class="badge ${role.is_active ? 'active' : 'inactive'}">${role.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td><span class="badge ${role.is_system_role ? 'system' : ''}">${role.is_system_role ? 'System' : 'Custom'}</span></td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table>';
                    resultDiv.innerHTML = tableHTML;
                    
                    // Update dropdowns
                    updateRoleDropdowns();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Update role dropdowns
        function updateRoleDropdowns() {
            const updateSelect = document.getElementById('updateRoleSelect');
            const deleteSelect = document.getElementById('deleteRoleSelect');
            const viewUsersSelect = document.getElementById('viewUsersRoleSelect');
            
            [updateSelect, deleteSelect, viewUsersSelect].forEach(select => {
                select.innerHTML = '<option value="">Select a role...</option>';
                rolesData.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = `${role.name} (${role.code})`;
                    option.dataset.role = JSON.stringify(role);
                    select.appendChild(option);
                });
            });
        }

        // Create role
        async function createRole() {
            const resultDiv = document.getElementById('createResult');
            const name = document.getElementById('roleName').value;
            const code = document.getElementById('roleCode').value;
            const description = document.getElementById('roleDescription').value;
            const permissionType = document.getElementById('permissionType').value;

            if (!authToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please login first';
                return;
            }

            if (!name || !code) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Name and code are required';
                return;
            }

            const permissions = permissionType === 'all' ? { all: true } : {
                'tickets.read': true,
                'tickets.create': true,
                'reports.read': true
            };

            try {
                const response = await fetch(`${API_BASE}/roles`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, code, description, permissions })
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${result.message}\n\n${JSON.stringify(result.data, null, 2)}`;
                    
                    // Clear form
                    document.getElementById('roleName').value = '';
                    document.getElementById('roleCode').value = '';
                    document.getElementById('roleDescription').value = '';
                    
                    // Refresh roles list
                    setTimeout(getAllRoles, 500);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Update role
        async function updateRole() {
            const resultDiv = document.getElementById('updateResult');
            const roleId = document.getElementById('updateRoleSelect').value;
            const name = document.getElementById('updateRoleName').value;
            const description = document.getElementById('updateRoleDescription').value;
            const isActive = document.getElementById('updateRoleStatus').value === 'true';

            if (!authToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please login first';
                return;
            }

            if (!roleId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please select a role';
                return;
            }

            const updateData = {};
            if (name) updateData.name = name;
            if (description) updateData.description = description;
            updateData.is_active = isActive;

            try {
                const response = await fetch(`${API_BASE}/roles/${roleId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${result.message}\n\n${JSON.stringify(result.data, null, 2)}`;
                    
                    // Refresh roles list
                    setTimeout(getAllRoles, 500);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Delete role
        async function deleteRole() {
            const resultDiv = document.getElementById('deleteResult');
            const roleId = document.getElementById('deleteRoleSelect').value;
            const selectedOption = document.querySelector(`#deleteRoleSelect option[value="${roleId}"]`);

            if (!authToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please login first';
                return;
            }

            if (!roleId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please select a role';
                return;
            }

            const roleName = selectedOption ? selectedOption.textContent : 'Unknown';
            
            if (!confirm(`Are you sure you want to delete role: ${roleName}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/roles/${roleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${result.message}`;
                    
                    // Refresh roles list
                    setTimeout(getAllRoles, 500);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // View users by role
        async function viewUsersByRole() {
            const resultDiv = document.getElementById('viewUsersResult');
            const roleId = document.getElementById('viewUsersRoleSelect').value;
            const selectedOption = document.querySelector(`#viewUsersRoleSelect option[value="${roleId}"]`);

            if (!authToken) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please login first';
                return;
            }

            if (!roleId) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please select a role';
                return;
            }

            const roleName = selectedOption ? selectedOption.textContent : 'Unknown';

            try {
                const response = await fetch(`${API_BASE}/roles/${roleId}/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    const users = result.data || [];
                    resultDiv.className = 'result success';
                    
                    if (users.length === 0) {
                        resultDiv.textContent = `‚ÑπÔ∏è No users found with role: ${roleName}`;
                    } else {
                        let usersText = `üë• Users with role: ${roleName} (${users.length} users)\n\n`;
                        users.forEach((user, index) => {
                            usersText += `${index + 1}. ${user.full_name}\n`;
                            usersText += `   üìß ${user.email}\n`;
                            usersText += `   üè¢ ${user.units?.name || 'No unit'}\n`;
                            usersText += `   üìä ${user.is_active ? 'Active' : 'Inactive'}\n\n`;
                        });
                        resultDiv.textContent = usersText;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${result.message || 'Unknown error'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Clear all results
        function clearResults() {
            const resultDivs = document.querySelectorAll('.result');
            resultDivs.forEach(div => {
                div.className = 'result';
                div.textContent = '';
            });
        }

        // Auto-fill update form when role is selected
        document.getElementById('updateRoleSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.dataset.role) {
                const role = JSON.parse(selectedOption.dataset.role);
                document.getElementById('updateRoleName').value = role.name;
                document.getElementById('updateRoleDescription').value = role.description || '';
                document.getElementById('updateRoleStatus').value = role.is_active.toString();
            }
        });

        // Initialize
        checkConnection();
    </script>
</body>
</html>