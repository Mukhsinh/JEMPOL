<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Form Internal Ticket - Vercel Fixed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        .info {
            background: #dbeafe;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2563eb;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1f2937;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .loading {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        label {
            font-weight: 600;
            color: #374151;
            display: block;
            margin-top: 12px;
        }
        .form-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Form Internal Ticket - Vercel Fixed</h1>
        
        <div class="info">
            <strong>üìã Perbaikan yang dilakukan:</strong><br>
            ‚úÖ Memperbaiki routing Vercel (vercel.json)<br>
            ‚úÖ Memastikan API selalu return JSON<br>
            ‚úÖ Memperbaiki error 405 Method Not Allowed<br>
            ‚úÖ Set Content-Type header sebelum try/catch
        </div>

        <!-- Test 1: Get Units -->
        <div class="test-section">
            <h3>Test 1: Get Units</h3>
            <p>Endpoint: <code>GET /api/public/units</code></p>
            <button onclick="testGetUnits()">üß™ Test Get Units</button>
            <div id="units-result"></div>
        </div>

        <!-- Test 2: Get App Settings -->
        <div class="test-section">
            <h3>Test 2: Get App Settings</h3>
            <p>Endpoint: <code>GET /api/public/app-settings</code></p>
            <button onclick="testGetAppSettings()">üß™ Test Get App Settings</button>
            <div id="settings-result"></div>
        </div>

        <!-- Test 3: Submit Internal Ticket -->
        <div class="test-section">
            <h3>Test 3: Submit Internal Ticket</h3>
            <p>Endpoint: <code>POST /api/public/internal-tickets</code></p>
            
            <div class="form-group">
                <label>Nama Pelapor *</label>
                <input type="text" id="reporter_name" value="Test User" required>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="reporter_email" value="test@example.com">
            </div>

            <div class="form-group">
                <label>Telepon</label>
                <input type="tel" id="reporter_phone" value="081234567890">
            </div>

            <div class="form-group">
                <label>Unit *</label>
                <select id="unit_id" required>
                    <option value="">-- Pilih Unit --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Prioritas *</label>
                <select id="priority" required>
                    <option value="low">Rendah</option>
                    <option value="medium" selected>Sedang</option>
                    <option value="high">Tinggi</option>
                    <option value="critical">Kritis</option>
                </select>
            </div>

            <div class="form-group">
                <label>Judul *</label>
                <input type="text" id="title" value="Test Tiket Internal dari Vercel" required>
            </div>

            <div class="form-group">
                <label>Deskripsi *</label>
                <textarea id="description" rows="4" required>Ini adalah test tiket internal setelah perbaikan routing Vercel.</textarea>
            </div>

            <button onclick="testSubmitTicket()">üß™ Test Submit Ticket</button>
            <div id="submit-result"></div>
        </div>
    </div>

    <script>
        // Ganti dengan URL Vercel Anda
        const VERCEL_URL = window.location.origin;
        
        console.log('üåê Testing Vercel URL:', VERCEL_URL);

        // Test Get Units
        async function testGetUnits() {
            const resultDiv = document.getElementById('units-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Loading units...';

            try {
                console.log('üéØ Testing GET /api/public/units');
                
                const response = await fetch(`${VERCEL_URL}/api/public/units`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', response.headers.get('content-type'));

                const text = await response.text();
                console.log('üì• Response text:', text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Response bukan JSON: ' + text.substring(0, 100));
                }

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Berhasil!\n\nJumlah units: ${data.data?.length || 0}\n\n${JSON.stringify(data, null, 2)}`;
                    
                    // Populate unit dropdown
                    const unitSelect = document.getElementById('unit_id');
                    unitSelect.innerHTML = '<option value="">-- Pilih Unit --</option>';
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit.id;
                            option.textContent = unit.name;
                            unitSelect.appendChild(option);
                        });
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${data.error}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Test Get App Settings
        async function testGetAppSettings() {
            const resultDiv = document.getElementById('settings-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Loading app settings...';

            try {
                console.log('üéØ Testing GET /api/public/app-settings');
                
                const response = await fetch(`${VERCEL_URL}/api/public/app-settings`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', response.headers.get('content-type'));

                const text = await response.text();
                console.log('üì• Response text:', text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Response bukan JSON: ' + text.substring(0, 100));
                }

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Berhasil!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${data.error}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Test Submit Ticket
        async function testSubmitTicket() {
            const resultDiv = document.getElementById('submit-result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Submitting ticket...';

            try {
                const ticketData = {
                    reporter_name: document.getElementById('reporter_name').value,
                    reporter_email: document.getElementById('reporter_email').value,
                    reporter_phone: document.getElementById('reporter_phone').value,
                    unit_id: document.getElementById('unit_id').value,
                    priority: document.getElementById('priority').value,
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    source: 'web'
                };

                console.log('üéØ Testing POST /api/public/internal-tickets');
                console.log('üì§ Request data:', ticketData);

                if (!ticketData.unit_id) {
                    throw new Error('Unit harus dipilih');
                }

                const response = await fetch(`${VERCEL_URL}/api/public/internal-tickets`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', response.headers.get('content-type'));

                const text = await response.text();
                console.log('üì• Response text:', text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Response bukan JSON: ' + text.substring(0, 100));
                }

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Berhasil!\n\nNomor Tiket: ${data.ticket_number}\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${data.error}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Auto load units on page load
        window.addEventListener('load', () => {
            console.log('üöÄ Page loaded, testing endpoints...');
            testGetUnits();
        });
    </script>
</body>
</html>
