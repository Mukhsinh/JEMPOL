<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Create Internal Ticket - Integrasi Master Data</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        select, input, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .error {
            color: #dc2626;
            background: #fef2f2;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .success {
            color: #059669;
            background: #f0fdf4;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .priority-low { color: #059669; }
        .priority-medium { color: #d97706; }
        .priority-high { color: #dc2626; }
        .priority-critical { color: #991b1b; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Create Internal Ticket - Integrasi Master Data</h1>
        
        <div class="card">
            <h2>Status Koneksi API</h2>
            <div id="connectionStatus">Mengecek koneksi...</div>
        </div>

        <div class="card">
            <h2>Data Master yang Dimuat</h2>
            <div class="grid">
                <div>
                    <h3>Tipe Tiket</h3>
                    <div id="ticketTypes">Loading...</div>
                </div>
                <div>
                    <h3>Kategori Layanan</h3>
                    <div id="serviceCategories">Loading...</div>
                </div>
                <div>
                    <h3>Unit Kerja</h3>
                    <div id="units">Loading...</div>
                </div>
                <div>
                    <h3>Prioritas</h3>
                    <div id="priorities">
                        <div class="priority-low">• Rendah</div>
                        <div class="priority-medium">• Sedang</div>
                        <div class="priority-high">• Tinggi</div>
                        <div class="priority-critical">• Kritis</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Form Buat Tiket Internal (Bahasa Indonesia)</h2>
            <div id="formMessage"></div>
            
            <form id="ticketForm">
                <div class="form-group">
                    <label for="title">Judul *</label>
                    <input type="text" id="title" name="title" placeholder="Ringkasan singkat masalah..." required>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="type">Tipe *</label>
                        <select id="type" name="type" required>
                            <option value="">Pilih tipe...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">Kategori *</label>
                        <select id="category" name="category" required>
                            <option value="">Pilih kategori...</option>
                        </select>
                    </div>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="priority">Prioritas *</label>
                        <select id="priority" name="priority" required>
                            <option value="low">Rendah</option>
                            <option value="medium" selected>Sedang</option>
                            <option value="high">Tinggi</option>
                            <option value="critical">Kritis</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="unit">Unit *</label>
                        <select id="unit" name="unit" required>
                            <option value="">Pilih unit...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Deskripsi *</label>
                    <textarea id="description" name="description" rows="4" placeholder="Berikan informasi detail tentang masalah..." required></textarea>
                </div>

                <button type="submit" id="submitBtn">Buat Tiket</button>
            </form>
        </div>

        <div class="card">
            <h2>Log Aktivitas</h2>
            <div id="activityLog" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let masterData = {
            ticketTypes: [],
            serviceCategories: [],
            units: []
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc2626' : type === 'success' ? '#059669' : '#374151';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('formMessage');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            messageDiv.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    document.getElementById('connectionStatus').innerHTML = '<span style="color: #059669;">✓ Koneksi API berhasil</span>';
                    log('Koneksi API berhasil', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = '<span style="color: #dc2626;">✗ Koneksi API gagal: ' + error.message + '</span>';
                log('Koneksi API gagal: ' + error.message, 'error');
                return false;
            }
        }

        async function loadMasterData() {
            try {
                log('Memuat data master...');

                // Load ticket types
                try {
                    const ticketTypesResponse = await fetch(`${API_BASE}/master-data/ticket-types`);
                    if (ticketTypesResponse.ok) {
                        masterData.ticketTypes = await ticketTypesResponse.json();
                        log(`Berhasil memuat ${masterData.ticketTypes.length} tipe tiket`, 'success');
                    } else {
                        throw new Error(`HTTP ${ticketTypesResponse.status}`);
                    }
                } catch (error) {
                    log('Gagal memuat tipe tiket: ' + error.message, 'error');
                    masterData.ticketTypes = [];
                }

                // Load service categories
                try {
                    const categoriesResponse = await fetch(`${API_BASE}/master-data/service-categories`);
                    if (categoriesResponse.ok) {
                        masterData.serviceCategories = await categoriesResponse.json();
                        log(`Berhasil memuat ${masterData.serviceCategories.length} kategori layanan`, 'success');
                    } else {
                        throw new Error(`HTTP ${categoriesResponse.status}`);
                    }
                } catch (error) {
                    log('Gagal memuat kategori layanan: ' + error.message, 'error');
                    masterData.serviceCategories = [];
                }

                // Load units
                try {
                    const unitsResponse = await fetch(`${API_BASE}/units`);
                    if (unitsResponse.ok) {
                        masterData.units = await unitsResponse.json();
                        log(`Berhasil memuat ${masterData.units.length} unit kerja`, 'success');
                    } else {
                        // Try public endpoint as fallback
                        const publicUnitsResponse = await fetch(`${API_BASE}/public/units`);
                        if (publicUnitsResponse.ok) {
                            masterData.units = await publicUnitsResponse.json();
                            log(`Berhasil memuat ${masterData.units.length} unit kerja (fallback)`, 'success');
                        } else {
                            throw new Error(`HTTP ${unitsResponse.status}`);
                        }
                    }
                } catch (error) {
                    log('Gagal memuat unit kerja: ' + error.message, 'error');
                    masterData.units = [];
                }

                updateUI();
            } catch (error) {
                log('Error loading master data: ' + error.message, 'error');
            }
        }

        function updateUI() {
            // Update ticket types display
            const ticketTypesDiv = document.getElementById('ticketTypes');
            const typeSelect = document.getElementById('type');
            
            if (masterData.ticketTypes.length > 0) {
                ticketTypesDiv.innerHTML = masterData.ticketTypes
                    .filter(t => t.is_active)
                    .map(t => `<div>• ${t.name} (${t.code})</div>`)
                    .join('');
                
                typeSelect.innerHTML = '<option value="">Pilih tipe...</option>' +
                    masterData.ticketTypes
                        .filter(t => t.is_active)
                        .map(t => `<option value="${t.code.toLowerCase()}">${t.name}</option>`)
                        .join('');
            } else {
                ticketTypesDiv.innerHTML = '<div style="color: #dc2626;">Tidak ada data</div>';
            }

            // Update service categories display
            const categoriesDiv = document.getElementById('serviceCategories');
            const categorySelect = document.getElementById('category');
            
            if (masterData.serviceCategories.length > 0) {
                categoriesDiv.innerHTML = masterData.serviceCategories
                    .filter(c => c.is_active)
                    .map(c => `<div>• ${c.name}</div>`)
                    .join('');
                
                categorySelect.innerHTML = '<option value="">Pilih kategori...</option>' +
                    masterData.serviceCategories
                        .filter(c => c.is_active)
                        .map(c => `<option value="${c.id}">${c.name}</option>`)
                        .join('');
            } else {
                categoriesDiv.innerHTML = '<div style="color: #dc2626;">Tidak ada data</div>';
            }

            // Update units display
            const unitsDiv = document.getElementById('units');
            const unitSelect = document.getElementById('unit');
            
            if (masterData.units.length > 0) {
                unitsDiv.innerHTML = masterData.units
                    .filter(u => u.is_active)
                    .map(u => `<div>• ${u.name} (${u.code})</div>`)
                    .join('');
                
                unitSelect.innerHTML = '<option value="">Pilih unit...</option>' +
                    masterData.units
                        .filter(u => u.is_active)
                        .map(u => `<option value="${u.id}">${u.name}</option>`)
                        .join('');
            } else {
                unitsDiv.innerHTML = '<div style="color: #dc2626;">Tidak ada data</div>';
            }
        }

        async function submitTicket(formData) {
            try {
                log('Mengirim data tiket...');
                
                const response = await fetch(`${API_BASE}/complaints`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log('Tiket berhasil dibuat: ' + JSON.stringify(result), 'success');
                    showMessage('Tiket berhasil dibuat!', 'success');
                    document.getElementById('ticketForm').reset();
                    return true;
                } else {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
            } catch (error) {
                log('Gagal membuat tiket: ' + error.message, 'error');
                showMessage('Gagal membuat tiket: ' + error.message, 'error');
                return false;
            }
        }

        // Event listeners
        document.getElementById('ticketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ticketData = {
                type: formData.get('type'),
                category_id: formData.get('category'),
                title: formData.get('title'),
                description: formData.get('description'),
                unit_id: formData.get('unit'),
                priority: formData.get('priority')
            };

            // Validate required fields
            if (!ticketData.title || !ticketData.type || !ticketData.category_id || 
                !ticketData.unit_id || !ticketData.description) {
                showMessage('Harap isi semua field yang diperlukan.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Membuat...';

            await submitTicket(ticketData);

            submitBtn.disabled = false;
            submitBtn.textContent = 'Buat Tiket';
        });

        // Initialize
        async function init() {
            log('Memulai test integrasi Create Internal Ticket...');
            
            const connected = await testConnection();
            if (connected) {
                await loadMasterData();
            }
        }

        init();
    </script>
</body>
</html>