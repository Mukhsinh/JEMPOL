<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Patient Types Auth Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Patient Types Auth Fix</h1>
        <p>Script untuk menguji perbaikan masalah 403 Forbidden pada endpoint patient-types</p>
    </div>

    <div class="container">
        <h2>üîê Authentication Test</h2>
        <div class="test-section info">
            <h3>Login Test</h3>
            <input type="email" id="email" placeholder="Email admin" value="admin@example.com" style="width: 200px; padding: 8px; margin: 5px;">
            <input type="password" id="password" placeholder="Password" value="admin123" style="width: 200px; padding: 8px; margin: 5px;">
            <button onclick="testLogin()">Test Login</button>
            <div id="loginStatus"></div>
        </div>
    </div>

    <div class="container">
        <h2>üìä Patient Types Endpoint Tests</h2>
        
        <div class="test-section">
            <h3>1. Public Endpoint Test (No Auth)</h3>
            <button onclick="testPublicEndpoint()">Test Public Access</button>
            <div id="publicResult"></div>
        </div>

        <div class="test-section">
            <h3>2. Protected Endpoint Test (With Auth)</h3>
            <button onclick="testProtectedEndpoint()" id="protectedBtn" disabled>Test Protected Access</button>
            <div id="protectedResult"></div>
        </div>

        <div class="test-section">
            <h3>3. Fallback Mechanism Test</h3>
            <button onclick="testFallbackMechanism()">Test Fallback</button>
            <div id="fallbackResult"></div>
        </div>
    </div>

    <div class="container">
        <h2>üîç Debug Information</h2>
        <div class="test-section">
            <button onclick="showDebugInfo()">Show Debug Info</button>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3003/api';
        let authToken = null;

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showLoading(elementId, message = 'Loading...') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="loading">${message}</div>`;
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showStatus('loginStatus', '‚ùå Email dan password harus diisi', 'error');
                return;
            }

            showLoading('loginStatus', 'Mencoba login...');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    authToken = data.data?.session?.access_token || data.token;
                    showStatus('loginStatus', `‚úÖ Login berhasil! Token: ${authToken ? 'Available' : 'Not found'}`, 'success');
                    document.getElementById('protectedBtn').disabled = false;
                } else {
                    showStatus('loginStatus', `‚ùå Login gagal: ${data.error || data.message}`, 'error');
                }
            } catch (error) {
                showStatus('loginStatus', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testPublicEndpoint() {
            showLoading('publicResult', 'Testing public endpoint...');

            try {
                const response = await fetch(`${API_BASE_URL}/master-data/public/patient-types`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('publicResult', 
                        `‚úÖ Public endpoint berhasil!<br>
                        Status: ${response.status}<br>
                        Data count: ${Array.isArray(data) ? data.length : 'N/A'}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'success'
                    );
                } else {
                    showStatus('publicResult', 
                        `‚ùå Public endpoint gagal!<br>
                        Status: ${response.status}<br>
                        Error: ${data.error || 'Unknown error'}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'error'
                    );
                }
            } catch (error) {
                showStatus('publicResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function testProtectedEndpoint() {
            if (!authToken) {
                showStatus('protectedResult', '‚ùå Token tidak tersedia. Login terlebih dahulu.', 'error');
                return;
            }

            showLoading('protectedResult', 'Testing protected endpoint...');

            try {
                const response = await fetch(`${API_BASE_URL}/master-data/patient-types`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('protectedResult', 
                        `‚úÖ Protected endpoint berhasil!<br>
                        Status: ${response.status}<br>
                        Data count: ${Array.isArray(data) ? data.length : 'N/A'}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'success'
                    );
                } else {
                    showStatus('protectedResult', 
                        `‚ùå Protected endpoint gagal!<br>
                        Status: ${response.status}<br>
                        Error: ${data.error || 'Unknown error'}<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'error'
                    );
                }
            } catch (error) {
                showStatus('protectedResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function testFallbackMechanism() {
            showLoading('fallbackResult', 'Testing fallback mechanism...');

            try {
                // Test dengan token invalid untuk memicu fallback
                const response = await fetch(`${API_BASE_URL}/master-data/patient-types`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer invalid-token-to-trigger-fallback'
                    }
                });

                const data = await response.json();

                if (response.status === 403) {
                    showStatus('fallbackResult', 
                        `‚úÖ Fallback mechanism working!<br>
                        Status: ${response.status} (Expected)<br>
                        Error: ${data.error}<br>
                        Frontend should now try public endpoint`, 
                        'success'
                    );
                } else {
                    showStatus('fallbackResult', 
                        `‚ö†Ô∏è Unexpected response:<br>
                        Status: ${response.status}<br>
                        Data: <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'info'
                    );
                }
            } catch (error) {
                showStatus('fallbackResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function showDebugInfo() {
            showLoading('debugInfo', 'Collecting debug information...');

            const debugData = {
                timestamp: new Date().toISOString(),
                apiBaseUrl: API_BASE_URL,
                authToken: authToken ? 'Present' : 'Not available',
                userAgent: navigator.userAgent,
                location: window.location.href
            };

            // Test server connectivity
            try {
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                debugData.serverHealth = {
                    status: healthResponse.status,
                    ok: healthResponse.ok
                };
            } catch (error) {
                debugData.serverHealth = {
                    error: error.message
                };
            }

            showStatus('debugInfo', 
                `<h4>Debug Information:</h4>
                <pre>${JSON.stringify(debugData, null, 2)}</pre>`, 
                'info'
            );
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            console.log('üîß Patient Types Auth Fix Test Page Loaded');
            console.log('API Base URL:', API_BASE_URL);
            
            // Auto test public endpoint
            setTimeout(() => {
                testPublicEndpoint();
            }, 1000);
        });
    </script>
</body>
</html>