<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Auth Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Debug Authentication Flow</h1>
    <div id="status"></div>
    
    <div style="margin: 20px 0;">
        <button onclick="checkAuthState()">Check Auth State</button>
        <button onclick="loginTest()">Login Test</button>
        <button onclick="testApiCall()">Test API Call</button>
        <button onclick="clearAuth()">Clear Auth</button>
    </div>
    
    <div id="results" style="background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; font-family: monospace;"></div>

    <script>
        const supabaseUrl = 'https://jxxzbdivafzzwqhagwrf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eHpiZGl2YWZ6endxaGFnd3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MTkwNTEsImV4cCI6MjA4MDQ5NTA1MX0.ICOtGuxrD19GtawdR9JAsnFn9XsHxWkr1aHCEkgHqXg';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        function log(message) {
            const results = document.getElementById('results');
            results.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('results').textContent = '';
        }
        
        async function checkAuthState() {
            clearLog();
            log('=== Checking Auth State ===');
            
            try {
                // Check session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                log('Session check - Error: ' + (sessionError ? sessionError.message : 'None'));
                log('Session available: ' + (session ? 'Yes' : 'No'));
                
                if (session) {
                    log('User email: ' + session.user.email);
                    log('Token expires at: ' + new Date(session.expires_at * 1000).toLocaleString());
                    log('Token (first 50 chars): ' + session.access_token.substring(0, 50) + '...');
                }
                
                // Check user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                log('User check - Error: ' + (userError ? userError.message : 'None'));
                log('User available: ' + (user ? 'Yes' : 'No'));
                
                // Check localStorage
                const adminUser = localStorage.getItem('adminUser');
                log('LocalStorage adminUser: ' + (adminUser ? 'Available' : 'Not found'));
                if (adminUser) {
                    try {
                        const parsed = JSON.parse(adminUser);
                        log('AdminUser data: ' + JSON.stringify(parsed, null, 2));
                    } catch (e) {
                        log('AdminUser parse error: ' + e.message);
                    }
                }
                
            } catch (error) {
                log('Auth state check error: ' + error.message);
            }
        }
        
        async function loginTest() {
            clearLog();
            log('=== Testing Login ===');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@jempol.com',
                    password: 'admin123'
                });
                
                if (error) {
                    log('Login error: ' + error.message);
                    return;
                }
                
                log('Login successful!');
                log('User: ' + data.user.email);
                log('Session: ' + (data.session ? 'Available' : 'Not available'));
                
                if (data.session) {
                    log('Access token: ' + data.session.access_token.substring(0, 50) + '...');
                    
                    // Simulate what authService does
                    const { data: adminProfile, error: profileError } = await supabase
                        .from('admins')
                        .select('*')
                        .eq('email', 'admin@jempol.com')
                        .eq('is_active', true)
                        .single();
                    
                    if (profileError) {
                        log('Admin profile error: ' + profileError.message);
                    } else {
                        log('Admin profile found: ' + adminProfile.full_name);
                        
                        // Store admin data like authService does
                        const adminData = {
                            id: adminProfile.id,
                            username: adminProfile.username,
                            full_name: adminProfile.full_name,
                            email: adminProfile.email,
                            role: adminProfile.role || 'admin',
                        };
                        
                        localStorage.setItem('adminUser', JSON.stringify(adminData));
                        log('Admin data stored in localStorage');
                    }
                }
                
            } catch (err) {
                log('Login exception: ' + err.message);
            }
        }
        
        async function testApiCall() {
            clearLog();
            log('=== Testing API Call ===');
            
            try {
                // Get token like authService does
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    log('No session found - please login first');
                    return;
                }
                
                const token = session.access_token;
                log('Using token: ' + token.substring(0, 50) + '...');
                
                // Make API call
                const response = await fetch('http://localhost:5001/api/complaints/tickets', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('Response status: ' + response.status);
                log('Response headers: ' + JSON.stringify([...response.headers.entries()]));
                
                const responseText = await response.text();
                log('Response body: ' + responseText);
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log('Parsed response: ' + JSON.stringify(data, null, 2));
                    } catch (e) {
                        log('JSON parse error: ' + e.message);
                    }
                }
                
            } catch (err) {
                log('API call error: ' + err.message);
            }
        }
        
        async function clearAuth() {
            clearLog();
            log('=== Clearing Auth ===');
            
            try {
                await supabase.auth.signOut();
                localStorage.removeItem('adminUser');
                log('Auth cleared');
            } catch (err) {
                log('Clear auth error: ' + err.message);
            }
        }
        
        // Auto-check auth state on load
        window.addEventListener('load', checkAuthState);
        
        // Listen to auth changes
        supabase.auth.onAuthStateChange((event, session) => {
            log('Auth state changed: ' + event + ' - Session: ' + (session ? 'Available' : 'None'));
        });
    </script>
</body>
</html>