<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Track Ticket - Fixed</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .test-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
    }
    input, button {
      padding: 12px 20px;
      margin: 5px;
      border-radius: 8px;
      border: 2px solid #ddd;
      font-size: 14px;
    }
    input {
      width: 300px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 10px;
    }
    .badge-success { background: #28a745; color: white; }
    .badge-error { background: #dc3545; color: white; }
    .badge-info { background: #17a2b8; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Test Track Ticket - Fixed</h1>
    <p class="subtitle">Testing endpoint pelacakan tiket dengan error handling yang lebih baik</p>

    <div class="test-section">
      <h3>üìã Test 1: Track Ticket dengan Nomor Valid</h3>
      <input type="text" id="ticketNumber1" placeholder="Masukkan nomor tiket (contoh: TKT-2026-0003)" value="TKT-2026-0003">
      <button onclick="testTrackTicket('ticketNumber1', 'result1')">Test Track Ticket</button>
      <div id="result1"></div>
    </div>

    <div class="test-section">
      <h3>‚ùå Test 2: Track Ticket dengan Nomor Tidak Valid</h3>
      <input type="text" id="ticketNumber2" placeholder="Nomor tiket tidak valid" value="TKT-9999-9999">
      <button onclick="testTrackTicket('ticketNumber2', 'result2')">Test Track Ticket</button>
      <div id="result2"></div>
    </div>

    <div class="test-section">
      <h3>üîó Test 3: Test dengan URL Parameter</h3>
      <input type="text" id="ticketNumber3" placeholder="Nomor tiket" value="TKT-2026-0001">
      <button onclick="testWithUrlParam('ticketNumber3', 'result3')">Test dengan URL Param</button>
      <div id="result3"></div>
    </div>

    <div class="test-section">
      <h3>üåê Test 4: Test Content-Type Header</h3>
      <button onclick="testContentType('result4')">Test Content-Type</button>
      <div id="result4"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3005/api';

    async function testTrackTicket(inputId, resultId) {
      const ticketNumber = document.getElementById(inputId).value.trim();
      const resultDiv = document.getElementById(resultId);
      
      if (!ticketNumber) {
        resultDiv.innerHTML = '<div class="result error">‚ùå Nomor tiket harus diisi!</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="result info">‚è≥ Sedang melacak tiket...<span class="loading"></span></div>';

      try {
        console.log('üéØ Testing track ticket:', ticketNumber);
        
        const response = await fetch(
          `${API_URL}/public/track-ticket?ticket=${encodeURIComponent(ticketNumber)}`,
          {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          }
        );

        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));

        // Cek content-type
        const contentType = response.headers.get('content-type');
        console.log('üìÑ Content-Type:', contentType);

        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('‚ùå Response bukan JSON:', text.substring(0, 200));
          resultDiv.innerHTML = `
            <div class="result error">
              <strong>‚ùå Error: Response bukan JSON</strong><br>
              Content-Type: ${contentType || 'tidak ada'}<br>
              Response: ${text.substring(0, 200)}...
            </div>
          `;
          return;
        }

        const data = await response.json();
        console.log('‚úÖ Response data:', data);

        if (data.success) {
          resultDiv.innerHTML = `
            <div class="result success">
              <strong>‚úÖ Tiket Ditemukan!</strong>
              <span class="badge badge-success">SUCCESS</span><br><br>
              <strong>Nomor Tiket:</strong> ${data.data.ticket.ticket_number}<br>
              <strong>Judul:</strong> ${data.data.ticket.title}<br>
              <strong>Status:</strong> ${data.data.ticket.status}<br>
              <strong>Prioritas:</strong> ${data.data.ticket.priority}<br>
              <strong>Unit:</strong> ${data.data.ticket.unit?.name || '-'}<br>
              <strong>Kategori:</strong> ${data.data.ticket.category?.name || '-'}<br>
              <strong>Timeline Events:</strong> ${data.data.timeline.length}<br>
              <strong>Total Responses:</strong> ${data.data.stats.totalResponses}<br>
              <strong>Total Escalations:</strong> ${data.data.stats.totalEscalations}<br><br>
              <details>
                <summary style="cursor: pointer; color: #667eea; font-weight: bold;">üìã Lihat Detail Lengkap</summary>
                <pre>${JSON.stringify(data, null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="result error">
              <strong>‚ùå Error</strong>
              <span class="badge badge-error">FAILED</span><br><br>
              ${data.error || 'Terjadi kesalahan'}
            </div>
          `;
        }
      } catch (error) {
        console.error('‚ùå Error:', error);
        resultDiv.innerHTML = `
          <div class="result error">
            <strong>‚ùå Exception Caught</strong>
            <span class="badge badge-error">ERROR</span><br><br>
            ${error.message}<br><br>
            <details>
              <summary style="cursor: pointer;">Stack Trace</summary>
              <pre>${error.stack}</pre>
            </details>
          </div>
        `;
      }
    }

    async function testWithUrlParam(inputId, resultId) {
      const ticketNumber = document.getElementById(inputId).value.trim();
      const resultDiv = document.getElementById(resultId);
      
      if (!ticketNumber) {
        resultDiv.innerHTML = '<div class="result error">‚ùå Nomor tiket harus diisi!</div>';
        return;
      }

      resultDiv.innerHTML = `
        <div class="result info">
          <strong>üîó URL yang akan dibuka:</strong><br>
          http://localhost:3005/track-ticket?ticket=${encodeURIComponent(ticketNumber)}<br><br>
          <button onclick="window.open('http://localhost:3005/track-ticket?ticket=${encodeURIComponent(ticketNumber)}', '_blank')" 
                  style="padding: 8px 16px; margin-top: 10px;">
            üöÄ Buka di Tab Baru
          </button>
        </div>
      `;
    }

    async function testContentType(resultId) {
      const resultDiv = document.getElementById(resultId);
      resultDiv.innerHTML = '<div class="result info">‚è≥ Testing content-type...<span class="loading"></span></div>';

      try {
        const response = await fetch(`${API_URL}/public/track-ticket?ticket=TKT-2026-0001`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        const contentType = response.headers.get('content-type');
        const allHeaders = Object.fromEntries(response.headers.entries());

        resultDiv.innerHTML = `
          <div class="result ${contentType && contentType.includes('application/json') ? 'success' : 'error'}">
            <strong>üìÑ Content-Type Check</strong><br><br>
            <strong>Content-Type:</strong> ${contentType || 'tidak ada'}<br>
            <strong>Status:</strong> ${response.status}<br>
            <strong>Is JSON:</strong> ${contentType && contentType.includes('application/json') ? '‚úÖ Ya' : '‚ùå Tidak'}<br><br>
            <details>
              <summary style="cursor: pointer;">All Headers</summary>
              <pre>${JSON.stringify(allHeaders, null, 2)}</pre>
            </details>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="result error">
            <strong>‚ùå Error</strong><br><br>
            ${error.message}
          </div>
        `;
      }
    }

    // Auto-test saat halaman dimuat
    window.addEventListener('load', () => {
      console.log('üöÄ Halaman test dimuat');
      console.log('üìç API URL:', API_URL);
    });
  </script>
</body>
</html>
