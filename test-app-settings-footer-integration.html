<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test App Settings - Footer Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-center">Test App Settings - Footer Integration</h1>
        
        <!-- Test Results -->
        <div id="results" class="space-y-4 mb-8"></div>
        
        <!-- Settings Form Preview -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Preview Form Settings</h2>
            <div id="settingsPreview" class="space-y-4"></div>
        </div>

        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="flex flex-wrap gap-4">
                <button onclick="testGetSettings()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Get Settings
                </button>
                <button onclick="testUpdateSettings()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Update Settings
                </button>
                <button onclick="testPublicSettings()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Get Public Settings
                </button>
                <button onclick="clearResults()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Clear Results
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const colors = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700',
                warning: 'bg-yellow-100 border-yellow-500 text-yellow-700'
            };
            
            const div = document.createElement('div');
            div.className = `border-l-4 p-4 ${colors[type]}`;
            div.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <span class="material-symbols-outlined">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium">${title}</h3>
                        <div class="mt-2 text-sm">
                            <pre class="whitespace-pre-wrap">${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>
                        </div>
                    </div>
                </div>
            `;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('settingsPreview').innerHTML = '';
        }

        async function getAuthToken() {
            // Try to get token from localStorage first
            let token = localStorage.getItem('token');
            
            if (!token) {
                // If no token, try to login with test credentials
                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: 'admin',
                            password: 'admin123'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        token = data.token;
                        localStorage.setItem('token', token);
                        addResult('Login Success', 'Successfully logged in with test credentials', 'success');
                    } else {
                        throw new Error('Login failed');
                    }
                } catch (error) {
                    addResult('Login Error', `Failed to login: ${error.message}`, 'error');
                    return null;
                }
            }
            
            return token;
        }

        async function testGetSettings() {
            try {
                const token = await getAuthToken();
                if (!token) return;

                const response = await fetch(`${API_BASE}/app-settings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult('Get Settings Success', data, 'success');
                    
                    // Show preview
                    displaySettingsPreview(data);
                } else {
                    const error = await response.text();
                    addResult('Get Settings Error', `HTTP ${response.status}: ${error}`, 'error');
                }
            } catch (error) {
                addResult('Get Settings Error', error.message, 'error');
            }
        }

        async function testUpdateSettings() {
            try {
                const token = await getAuthToken();
                if (!token) return;

                const testSettings = {
                    app_name: 'Sistem Pengaduan Masyarakat Terpadu - Test Footer',
                    app_footer: 'Copyright Â© 2025 Test Footer Integration. Semua hak dilindungi. | Powered by KISS System',
                    institution_name: 'RSUD Test Footer Integration',
                    manager_name: 'Dr. Test Footer Manager',
                    manager_position: 'Kepala Bagian Test Footer',
                    job_title: 'Koordinator Footer Test',
                    logo_url: 'https://example.com/test-footer-logo.png',
                    description: 'Deskripsi test untuk footer integration',
                    address: 'Jl. Test Footer No. 123, Kota Test Footer',
                    contact_email: 'test-footer@instansi.go.id',
                    contact_phone: '(021) 1111-2222',
                    website: 'https://test-footer.instansi.go.id'
                };

                const response = await fetch(`${API_BASE}/app-settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testSettings)
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult('Update Settings Success', data, 'success');
                    
                    // Refresh settings display
                    setTimeout(() => testGetSettings(), 1000);
                } else {
                    const error = await response.text();
                    addResult('Update Settings Error', `HTTP ${response.status}: ${error}`, 'error');
                }
            } catch (error) {
                addResult('Update Settings Error', error.message, 'error');
            }
        }

        async function testPublicSettings() {
            try {
                const response = await fetch(`${API_BASE}/app-settings/public`);

                if (response.ok) {
                    const data = await response.json();
                    addResult('Get Public Settings Success', data, 'success');
                } else {
                    const error = await response.text();
                    addResult('Get Public Settings Error', `HTTP ${response.status}: ${error}`, 'error');
                }
            } catch (error) {
                addResult('Get Public Settings Error', error.message, 'error');
            }
        }

        function displaySettingsPreview(settings) {
            const preview = document.getElementById('settingsPreview');
            const settingsMap = {};
            
            // Convert array to map
            settings.forEach(setting => {
                settingsMap[setting.setting_key] = setting.setting_value;
            });

            const requiredFields = [
                { key: 'app_name', label: 'Nama Aplikasi', icon: 'apps' },
                { key: 'app_footer', label: 'Footer Aplikasi', icon: 'text_fields' },
                { key: 'institution_name', label: 'Nama Instansi', icon: 'apartment' },
                { key: 'logo_url', label: 'Logo Aplikasi', icon: 'image' },
                { key: 'address', label: 'Alamat Instansi', icon: 'location_on' }
            ];

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            requiredFields.forEach(field => {
                const value = settingsMap[field.key] || 'Tidak diset';
                const isSet = settingsMap[field.key] && settingsMap[field.key].trim() !== '';
                
                html += `
                    <div class="border rounded-lg p-4 ${isSet ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <div class="flex items-center mb-2">
                            <span class="material-symbols-outlined mr-2 ${isSet ? 'text-green-600' : 'text-red-600'}">${field.icon}</span>
                            <h3 class="font-medium ${isSet ? 'text-green-800' : 'text-red-800'}">${field.label}</h3>
                        </div>
                        <p class="text-sm ${isSet ? 'text-green-700' : 'text-red-700'}">${value}</p>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add footer preview
            if (settingsMap.app_footer) {
                html += `
                    <div class="mt-6 p-4 bg-gray-100 border-t-2 border-gray-300 rounded-lg">
                        <h3 class="font-medium text-gray-800 mb-2">Preview Footer:</h3>
                        <p class="text-sm text-gray-600 text-center">${settingsMap.app_footer}</p>
                    </div>
                `;
            }
            
            preview.innerHTML = html;
        }

        // Auto-load settings on page load
        window.addEventListener('load', () => {
            testGetSettings();
        });
    </script>
</body>
</html>