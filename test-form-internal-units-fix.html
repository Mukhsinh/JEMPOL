<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Form Internal - Units Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #7c3aed;
            margin-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #6d28d9;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .test-step {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #7c3aed;
            background: #f9fafb;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>üîß Test Perbaikan Units Loading</h1>
        <p>Test untuk memastikan error "units.map is not a function" sudah diperbaiki</p>
        
        <div class="status info">
            <strong>üìã Perbaikan yang dilakukan:</strong>
            <ul>
                <li>‚úÖ Menambahkan pengecekan Array.isArray() sebelum units.map()</li>
                <li>‚úÖ Memperbaiki parsing response API (result.data)</li>
                <li>‚úÖ Menambahkan fallback ke array kosong jika fetch gagal</li>
                <li>‚úÖ Memastikan units selalu berupa array</li>
            </ul>
        </div>

        <div class="test-step">
            <strong>Test 1: Cek Endpoint Units</strong>
            <button onclick="testUnitsEndpoint()">Test API /api/public/units</button>
        </div>

        <div class="test-step">
            <strong>Test 2: Buka Form Internal</strong>
            <button onclick="openForm()">Buka Form Internal</button>
        </div>

        <div class="test-step">
            <strong>Test 3: Simulasi Response API</strong>
            <button onclick="testResponseParsing()">Test Parsing Response</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        const resultDiv = document.getElementById('result');

        async function testUnitsEndpoint() {
            resultDiv.innerHTML = '<div class="status info">‚è≥ Mengambil data units...</div>';
            
            try {
                const response = await fetch('/api/public/units');
                const data = await response.json();
                
                console.log('üì• Response dari API:', data);
                
                // Cek format response
                let unitsArray;
                if (data?.data && Array.isArray(data.data)) {
                    unitsArray = data.data;
                } else if (Array.isArray(data)) {
                    unitsArray = data;
                } else {
                    unitsArray = [];
                }
                
                if (unitsArray.length > 0) {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>‚úÖ Berhasil!</strong><br>
                            Ditemukan ${unitsArray.length} units<br>
                            <br>
                            <strong>Sample data:</strong><br>
                            <pre>${JSON.stringify(unitsArray.slice(0, 2), null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <strong>‚ö†Ô∏è Tidak ada data units</strong><br>
                            Response: <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        <strong>‚ùå Error:</strong><br>
                        ${error.message}
                    </div>
                `;
                console.error('Error:', error);
            }
        }

        function openForm() {
            window.open('/form/internal', '_blank');
            resultDiv.innerHTML = `
                <div class="status success">
                    <strong>‚úÖ Form dibuka di tab baru</strong><br>
                    <br>
                    <strong>Cara verifikasi:</strong><br>
                    1. Buka Console (F12)<br>
                    2. Periksa log "‚úÖ Units loaded:"<br>
                    3. Pastikan tidak ada error "units.map is not a function"<br>
                    4. Cek dropdown Unit/Departemen terisi<br>
                </div>
            `;
        }

        function testResponseParsing() {
            // Simulasi berbagai format response
            const testCases = [
                { name: 'Format { success: true, data: [...] }', response: { success: true, data: [{ id: '1', name: 'Unit A' }] } },
                { name: 'Format array langsung', response: [{ id: '1', name: 'Unit A' }] },
                { name: 'Format kosong', response: { success: true, data: [] } },
                { name: 'Format null', response: null },
                { name: 'Format undefined', response: undefined }
            ];

            let results = '<strong>üß™ Test Parsing Response:</strong><br><br>';

            testCases.forEach(test => {
                const result = test.response;
                let unitsArray;
                
                // Logic yang sama dengan di component
                if (result?.data && Array.isArray(result.data)) {
                    unitsArray = result.data;
                } else if (Array.isArray(result)) {
                    unitsArray = result;
                } else {
                    unitsArray = [];
                }

                const isArray = Array.isArray(unitsArray);
                const canMap = isArray && typeof unitsArray.map === 'function';

                results += `
                    <div style="margin: 10px 0; padding: 10px; background: ${canMap ? '#d1fae5' : '#fee2e2'}; border-radius: 5px;">
                        <strong>${test.name}</strong><br>
                        Is Array: ${isArray ? '‚úÖ' : '‚ùå'}<br>
                        Can use .map(): ${canMap ? '‚úÖ' : '‚ùå'}<br>
                        Length: ${unitsArray.length}<br>
                    </div>
                `;
            });

            resultDiv.innerHTML = `<div class="status info">${results}</div>`;
        }

        // Auto test saat halaman dimuat
        window.addEventListener('load', () => {
            console.log('üîß Test page loaded');
            console.log('üìã Perbaikan yang dilakukan:');
            console.log('1. Menambahkan Array.isArray() check sebelum units.map()');
            console.log('2. Memperbaiki parsing response API');
            console.log('3. Menambahkan fallback ke array kosong');
        });
    </script>
</body>
</html>
