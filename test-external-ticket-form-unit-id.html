<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test External Ticket Form - Unit ID</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #ff6b35;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #ff6b35;
        }
        .test-link {
            display: block;
            padding: 15px;
            margin: 10px 0;
            background: #ff6b35;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .test-link:hover {
            background: #e55a2b;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background: #c8e6c9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #ffcdd2;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .url-display {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test External Ticket Form - Unit ID</h1>
        
        <div class="info">
            <strong>üìã Tujuan Test:</strong><br>
            Memverifikasi bahwa form tiket eksternal menerima dan memproses unit_id dengan benar
        </div>

        <div class="test-section">
            <h2>1Ô∏è‚É£ Test dengan QR Code (Recommended)</h2>
            <p>Scan QR code untuk test alur lengkap:</p>
            
            <a href="http://localhost:3002/qr/QR-PENGADUAN" class="test-link" target="_blank">
                üîó Test QR Pengaduan
            </a>
            <div class="url-display">http://localhost:3002/qr/QR-PENGADUAN</div>
            
            <a href="http://localhost:3002/qr/QR-ADM" class="test-link" target="_blank">
                üîó Test QR Administrasi
            </a>
            <div class="url-display">http://localhost:3002/qr/QR-ADM</div>
        </div>

        <div class="test-section">
            <h2>2Ô∏è‚É£ Test Direct URL dengan Parameter</h2>
            <p>Akses langsung form dengan parameter unit_id:</p>
            
            <a href="http://localhost:3002/form/eksternal?unit_id=550e8400-e29b-41d4-a716-446655440007&unit_name=Sub%20Bagian%20Pengaduan&qr=QR-PENGADUAN" class="test-link" target="_blank">
                üîó Form Eksternal - Sub Bagian Pengaduan
            </a>
            <div class="url-display">
                http://localhost:3002/form/eksternal?unit_id=550e8400-e29b-41d4-a716-446655440007&unit_name=Sub%20Bagian%20Pengaduan&qr=QR-PENGADUAN
            </div>

            <a href="http://localhost:3002/form/eksternal?unit_id=550e8400-e29b-41d4-a716-446655440003&unit_name=Bagian%20Administrasi&qr=QR-ADM" class="test-link" target="_blank">
                üîó Form Eksternal - Bagian Administrasi
            </a>
            <div class="url-display">
                http://localhost:3002/form/eksternal?unit_id=550e8400-e29b-41d4-a716-446655440003&unit_name=Bagian%20Administrasi&qr=QR-ADM
            </div>
        </div>

        <div class="test-section">
            <h2>3Ô∏è‚É£ Test Tanpa Parameter (Harus Error)</h2>
            <p>Test untuk memastikan validasi bekerja:</p>
            
            <a href="http://localhost:3002/form/eksternal" class="test-link" target="_blank">
                üîó Form Tanpa Parameter (Expected: Error)
            </a>
            <div class="url-display">http://localhost:3002/form/eksternal</div>
            
            <div class="error">
                <strong>‚ö†Ô∏è Expected Result:</strong><br>
                Harus muncul error: "Unit ID tidak ditemukan. Pastikan Anda mengakses form melalui QR code atau link yang benar."
            </div>
        </div>

        <div class="test-section">
            <h2>4Ô∏è‚É£ Checklist Test</h2>
            <div class="info">
                <strong>‚úÖ Yang Harus Dicek:</strong><br>
                <ul>
                    <li>‚úì Form terbuka tanpa sidebar (fullscreen)</li>
                    <li>‚úì Nama unit tampil di header</li>
                    <li>‚úì Tidak ada error "Unit ID tidak ditemukan"</li>
                    <li>‚úì Form bisa diisi dan submit</li>
                    <li>‚úì Setelah submit, dapat nomor tiket</li>
                    <li>‚úì Tiket tersimpan di database dengan unit_id yang benar</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>5Ô∏è‚É£ Debug Console</h2>
            <p>Buka Developer Console (F12) dan cek:</p>
            <div class="info">
                <code>‚úÖ Unit ID: [uuid]</code><br>
                <code>‚úÖ Unit Name: [nama unit]</code><br>
                <code>‚úÖ QR Code: [kode qr]</code>
            </div>
            <p>Jika muncul:</p>
            <div class="error">
                <code>‚ö†Ô∏è Unit ID tidak ditemukan di URL params</code>
            </div>
            <p>Berarti parameter tidak terkirim dengan benar.</p>
        </div>

        <div class="test-section">
            <h2>6Ô∏è‚É£ Test Submit Tiket</h2>
            <button onclick="testSubmitTicket()" class="test-link" style="cursor: pointer; border: none;">
                üß™ Test Submit API Langsung
            </button>
            <div id="submitResult"></div>
        </div>
    </div>

    <script>
        async function testSubmitTicket() {
            const resultDiv = document.getElementById('submitResult');
            resultDiv.innerHTML = '<div class="info">‚è≥ Mengirim test ticket...</div>';

            const testData = {
                unit_id: '550e8400-e29b-41d4-a716-446655440007',
                reporter_identity_type: 'personal',
                reporter_name: 'Test User',
                reporter_phone: '081234567890',
                reporter_email: 'test@example.com',
                service_type: 'complaint',
                title: 'Test Tiket dari HTML Test',
                description: 'Ini adalah test tiket untuk memverifikasi unit_id berfungsi dengan benar',
                qr_code: 'QR-PENGADUAN',
                source: 'web'
            };

            try {
                console.log('üì§ Sending test ticket:', testData);

                const response = await fetch('http://localhost:3001/api/public/external-tickets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                console.log('üì• Response:', result);

                if (response.ok && result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Berhasil!</strong><br>
                            Nomor Tiket: <strong>${result.ticket_number}</strong><br>
                            Ticket ID: ${result.ticket_id}<br>
                            <br>
                            <strong>AI Classification:</strong><br>
                            <pre>${JSON.stringify(result.ai_classification, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <strong>‚ùå Error!</strong><br>
                            ${result.error || result.message || 'Unknown error'}<br>
                            ${result.details ? `Details: ${result.details}` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Network Error!</strong><br>
                        ${error.message}<br>
                        <br>
                        Pastikan backend berjalan di http://localhost:3001
                    </div>
                `;
            }
        }

        // Auto-check URL parameters on page load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const unitId = urlParams.get('unit_id');
            const unitName = urlParams.get('unit_name');
            const qrCode = urlParams.get('qr');

            if (unitId || unitName || qrCode) {
                const info = document.createElement('div');
                info.className = 'success';
                info.innerHTML = `
                    <strong>üìç URL Parameters Detected:</strong><br>
                    Unit ID: ${unitId || 'tidak ada'}<br>
                    Unit Name: ${unitName || 'tidak ada'}<br>
                    QR Code: ${qrCode || 'tidak ada'}
                `;
                document.querySelector('.container').insertBefore(info, document.querySelector('.test-section'));
            }
        });
    </script>
</body>
</html>
