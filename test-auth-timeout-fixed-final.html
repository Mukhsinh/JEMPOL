<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth Timeout Fixed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f8fff8; }
        .error { border-color: #f44336; background-color: #fff8f8; }
        .warning { border-color: #ff9800; background-color: #fffaf0; }
        .info { border-color: #2196F3; background-color: #f0f8ff; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Perbaikan Auth Timeout</h1>
        <p>Script ini akan memverifikasi bahwa perbaikan auth timeout berhasil diterapkan.</p>

        <div class="test-section info">
            <h3>üìã Status Aplikasi</h3>
            <p><strong>Frontend:</strong> <span id="frontend-status">Checking...</span></p>
            <p><strong>Backend:</strong> <span id="backend-status">Checking...</span></p>
            <p><strong>Supabase:</strong> <span id="supabase-status">Checking...</span></p>
        </div>

        <div class="test-section">
            <h3>üîÑ Test Auth Initialization</h3>
            <button onclick="testAuthInit()">Test Auth Init Speed</button>
            <div id="auth-init-result"></div>
        </div>

        <div class="test-section">
            <h3>üîê Test Login Timeout</h3>
            <button onclick="testLoginTimeout()">Test Login Speed</button>
            <div id="login-timeout-result"></div>
        </div>

        <div class="test-section">
            <h3>üåê Test Supabase Connection</h3>
            <button onclick="testSupabaseConnection()">Test Connection Speed</button>
            <div id="supabase-connection-result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Test Results Summary</h3>
            <div id="test-summary"></div>
        </div>

        <div class="test-section info">
            <h3>‚ÑπÔ∏è Perbaikan yang Diterapkan</h3>
            <ul>
                <li>‚úÖ Auth initialization timeout: 30s ‚Üí 10s</li>
                <li>‚úÖ Login timeout: 30s ‚Üí 15s</li>
                <li>‚úÖ Supabase fetch timeout: 30s ‚Üí 15s</li>
                <li>‚úÖ Connection check timeout: ‚àû ‚Üí 5s</li>
                <li>‚úÖ Loading state dengan tombol refresh setelah 8s</li>
                <li>‚úÖ Retry mechanism dipercepat</li>
                <li>‚úÖ Error handling yang lebih baik</li>
            </ul>
        </div>
    </div>

    <script>
        let testResults = {
            authInit: null,
            loginTimeout: null,
            supabaseConnection: null
        };

        // Check application status
        async function checkApplicationStatus() {
            // Check frontend
            try {
                const frontendResponse = await fetch('http://localhost:3001', { 
                    method: 'HEAD',
                    signal: AbortSignal.timeout(5000)
                });
                document.getElementById('frontend-status').innerHTML = 
                    frontendResponse.ok ? '‚úÖ Running' : '‚ùå Error';
            } catch (error) {
                document.getElementById('frontend-status').innerHTML = '‚ùå Not Running';
            }

            // Check backend
            try {
                const backendResponse = await fetch('http://localhost:3004/api/health', {
                    signal: AbortSignal.timeout(5000)
                });
                document.getElementById('backend-status').innerHTML = 
                    backendResponse.ok ? '‚úÖ Running' : '‚ùå Error';
            } catch (error) {
                document.getElementById('backend-status').innerHTML = '‚ùå Not Running';
            }

            // Check Supabase (simplified)
            try {
                const supabaseUrl = 'https://jxxzbdivafzzwqhagwrf.supabase.co';
                const response = await fetch(supabaseUrl + '/rest/v1/', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eHpiZGl2YWZ6endxaGFnd3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MTkwNTEsImV4cCI6MjA4MDQ5NTA1MX0.ICOtGuxrD19GtawdR9JAsnFn9XsHxWkr1aHCEkgHqXg'
                    },
                    signal: AbortSignal.timeout(5000)
                });
                document.getElementById('supabase-status').innerHTML = 
                    response.status === 200 || response.status === 401 ? '‚úÖ Connected' : '‚ùå Error';
            } catch (error) {
                document.getElementById('supabase-status').innerHTML = '‚ùå Connection Failed';
            }
        }

        // Test auth initialization speed
        async function testAuthInit() {
            const resultDiv = document.getElementById('auth-init-result');
            resultDiv.innerHTML = '<div class="loading"></div> Testing auth initialization speed...';

            const startTime = Date.now();
            
            try {
                // Simulate auth initialization check
                const response = await fetch('http://localhost:3001', {
                    signal: AbortSignal.timeout(10000) // 10 second timeout as per fix
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                testResults.authInit = duration;
                
                if (duration < 5000) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ <strong>Excellent!</strong> Auth init completed in ${duration}ms<br>
                            <small>Much faster than the previous 30s timeout</small>
                        </div>
                    `;
                } else if (duration < 10000) {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è <strong>Good</strong> Auth init completed in ${duration}ms<br>
                            <small>Within the new 10s timeout limit</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå <strong>Slow</strong> Auth init took ${duration}ms<br>
                            <small>Still within timeout but slower than expected</small>
                        </div>
                    `;
                }
            } catch (error) {
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Failed</strong> Auth init failed after ${duration}ms<br>
                        <small>Error: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Test login timeout
        async function testLoginTimeout() {
            const resultDiv = document.getElementById('login-timeout-result');
            resultDiv.innerHTML = '<div class="loading"></div> Testing login timeout...';

            const startTime = Date.now();
            
            try {
                // Test login endpoint response time
                const response = await fetch('http://localhost:3004/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'test'
                    }),
                    signal: AbortSignal.timeout(15000) // 15 second timeout as per fix
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                testResults.loginTimeout = duration;
                
                if (duration < 3000) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ <strong>Excellent!</strong> Login endpoint responded in ${duration}ms<br>
                            <small>Much faster than the previous 30s timeout</small>
                        </div>
                    `;
                } else if (duration < 15000) {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è <strong>Good</strong> Login endpoint responded in ${duration}ms<br>
                            <small>Within the new 15s timeout limit</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå <strong>Slow</strong> Login took ${duration}ms<br>
                            <small>Approaching timeout limit</small>
                        </div>
                    `;
                }
            } catch (error) {
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (error.name === 'AbortError') {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå <strong>Timeout</strong> Login timed out after ${duration}ms<br>
                            <small>This should not happen with the new 15s timeout</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è <strong>Expected Error</strong> Login failed in ${duration}ms<br>
                            <small>Error: ${error.message} (This is expected for invalid credentials)</small>
                        </div>
                    `;
                }
            }
        }

        // Test Supabase connection
        async function testSupabaseConnection() {
            const resultDiv = document.getElementById('supabase-connection-result');
            resultDiv.innerHTML = '<div class="loading"></div> Testing Supabase connection speed...';

            const startTime = Date.now();
            
            try {
                const supabaseUrl = 'https://jxxzbdivafzzwqhagwrf.supabase.co';
                const response = await fetch(supabaseUrl + '/rest/v1/admins?select=count', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eHpiZGl2YWZ6endxaGFnd3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MTkwNTEsImV4cCI6MjA4MDQ5NTA1MX0.ICOtGuxrD19GtawdR9JAsnFn9XsHxWkr1aHCEkgHqXg',
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(5000) // 5 second timeout as per fix
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                testResults.supabaseConnection = duration;
                
                if (duration < 2000) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ <strong>Excellent!</strong> Supabase responded in ${duration}ms<br>
                            <small>Much faster than before with 5s timeout</small>
                        </div>
                    `;
                } else if (duration < 5000) {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è <strong>Good</strong> Supabase responded in ${duration}ms<br>
                            <small>Within the new 5s timeout limit</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå <strong>Slow</strong> Supabase took ${duration}ms<br>
                            <small>Approaching timeout limit</small>
                        </div>
                    `;
                }
            } catch (error) {
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (error.name === 'AbortError') {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå <strong>Timeout</strong> Supabase timed out after ${duration}ms<br>
                            <small>Connection issue or server overload</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è <strong>Connection Issue</strong> Failed in ${duration}ms<br>
                            <small>Error: ${error.message}</small>
                        </div>
                    `;
                }
            }
        }

        // Update test summary
        function updateTestSummary() {
            const summaryDiv = document.getElementById('test-summary');
            
            let summary = '<h4>üìä Performance Summary:</h4>';
            
            if (testResults.authInit !== null) {
                summary += `<p>üîÑ Auth Init: ${testResults.authInit}ms</p>`;
            }
            
            if (testResults.loginTimeout !== null) {
                summary += `<p>üîê Login Response: ${testResults.loginTimeout}ms</p>`;
            }
            
            if (testResults.supabaseConnection !== null) {
                summary += `<p>üåê Supabase Connection: ${testResults.supabaseConnection}ms</p>`;
            }

            const allFast = Object.values(testResults).every(result => 
                result === null || result < 5000
            );

            if (allFast && Object.values(testResults).some(result => result !== null)) {
                summary += `
                    <div class="success" style="margin-top: 15px;">
                        üéâ <strong>Perbaikan Berhasil!</strong><br>
                        Semua timeout sudah diperbaiki dan aplikasi merespons dengan cepat.
                    </div>
                `;
            }

            summaryDiv.innerHTML = summary;
        }

        // Auto-update summary when tests complete
        setInterval(updateTestSummary, 1000);

        // Check status on load
        checkApplicationStatus();

        console.log('üîß Auth Timeout Fix Test Ready');
        console.log('Perbaikan yang diterapkan:');
        console.log('- Auth init timeout: 30s ‚Üí 10s');
        console.log('- Login timeout: 30s ‚Üí 15s');
        console.log('- Supabase timeout: 30s ‚Üí 15s');
        console.log('- Connection check: ‚àû ‚Üí 5s');
    </script>
</body>
</html>