<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Eskalasi & Respon Tiket - Fixed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üîß Test Perbaikan Eskalasi & Respon Tiket</h1>
    
    <div class="container">
        <h2>üìã Status Perbaikan</h2>
        <div class="info result">
‚úÖ Perbaikan yang dilakukan:
1. Validasi user authentication sebelum insert
2. Pastikan from_user_id dan responder_id selalu ada
3. Return error 401 jika user tidak terautentikasi
4. Hapus conditional insert yang menyebabkan foreign key error
        </div>
    </div>

    <div class="grid">
        <!-- Test Eskalasi -->
        <div class="container">
            <h2>üì§ Test Eskalasi Tiket</h2>
            
            <div class="form-group">
                <label>Token (dari login):</label>
                <input type="text" id="escalateToken" placeholder="Paste token di sini">
            </div>

            <div class="form-group">
                <label>Ticket ID:</label>
                <input type="text" id="escalateTicketId" placeholder="ID tiket yang akan dieskalasi">
            </div>

            <div class="form-group">
                <label>Unit Tujuan ID:</label>
                <input type="text" id="escalateToUnitId" placeholder="ID unit tujuan">
            </div>

            <div class="form-group">
                <label>Alasan Eskalasi:</label>
                <textarea id="escalateReason" placeholder="Masukkan alasan eskalasi...">Memerlukan penanganan dari unit yang lebih tinggi</textarea>
            </div>

            <div class="form-group">
                <label>Catatan (opsional):</label>
                <textarea id="escalateNotes" placeholder="Catatan tambahan..."></textarea>
            </div>

            <button onclick="testEscalate()" id="escalateBtn">Eskalasi Tiket</button>
            
            <div id="escalateResult"></div>
        </div>

        <!-- Test Respon -->
        <div class="container">
            <h2>üí¨ Test Respon Tiket</h2>
            
            <div class="form-group">
                <label>Token (dari login):</label>
                <input type="text" id="respondToken" placeholder="Paste token di sini">
            </div>

            <div class="form-group">
                <label>Ticket ID:</label>
                <input type="text" id="respondTicketId" placeholder="ID tiket yang akan direspon">
            </div>

            <div class="form-group">
                <label>Pesan Respon:</label>
                <textarea id="respondMessage" placeholder="Masukkan pesan respon...">Terima kasih atas laporannya. Kami sedang menangani masalah ini.</textarea>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="respondInternal">
                    Internal Note (tidak terlihat oleh pelapor)
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="respondResolved">
                    Tandai sebagai Selesai
                </label>
            </div>

            <button onclick="testRespond()" id="respondBtn">Kirim Respon</button>
            
            <div id="respondResult"></div>
        </div>
    </div>

    <div class="container">
        <h2>üîç Cara Penggunaan</h2>
        <div class="info result">
<strong>Langkah-langkah:</strong>

1. Login terlebih dahulu di aplikasi untuk mendapatkan token
2. Copy token dari localStorage atau dari response login
3. Paste token ke field "Token" di form yang ingin ditest
4. Masukkan ID tiket yang valid
5. Untuk eskalasi: masukkan ID unit tujuan
6. Klik tombol untuk test

<strong>Catatan:</strong>
- Pastikan sudah login dengan user yang memiliki akses
- Token harus valid dan belum expired
- Ticket ID dan Unit ID harus ada di database
- Jika masih error, cek console browser untuk detail
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3004/api';

        async function testEscalate() {
            const btn = document.getElementById('escalateBtn');
            const resultDiv = document.getElementById('escalateResult');
            
            const token = document.getElementById('escalateToken').value.trim();
            const ticketId = document.getElementById('escalateTicketId').value.trim();
            const toUnitId = document.getElementById('escalateToUnitId').value.trim();
            const reason = document.getElementById('escalateReason').value.trim();
            const notes = document.getElementById('escalateNotes').value.trim();

            if (!token) {
                resultDiv.innerHTML = '<div class="error result">‚ùå Token wajib diisi!</div>';
                return;
            }

            if (!ticketId || !toUnitId || !reason) {
                resultDiv.innerHTML = '<div class="error result">‚ùå Ticket ID, Unit Tujuan, dan Alasan wajib diisi!</div>';
                return;
            }

            btn.disabled = true;
            resultDiv.innerHTML = '<div class="info result">‚è≥ Mengirim eskalasi...</div>';

            try {
                const response = await fetch(`${API_URL}/ticket-actions/tickets/${ticketId}/escalate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        to_unit_id: toUnitId,
                        reason: reason,
                        notes: notes || undefined
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    resultDiv.innerHTML = `
                        <div class="success result">
‚úÖ <strong>Eskalasi Berhasil!</strong>

Escalation ID: ${data.data.id}
Ticket ID: ${data.data.ticket_id}
To Unit: ${data.data.to_unit_id}
Reason: ${data.data.reason}
Status: ${data.data.escalation_type}

${data.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error result">
‚ùå <strong>Eskalasi Gagal</strong>

Status: ${response.status}
Error: ${data.error || 'Unknown error'}

${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error result">
‚ùå <strong>Error:</strong>
${error.message}

Pastikan:
- Backend berjalan di port 3004
- Token valid
- Ticket ID dan Unit ID ada di database
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        async function testRespond() {
            const btn = document.getElementById('respondBtn');
            const resultDiv = document.getElementById('respondResult');
            
            const token = document.getElementById('respondToken').value.trim();
            const ticketId = document.getElementById('respondTicketId').value.trim();
            const message = document.getElementById('respondMessage').value.trim();
            const isInternal = document.getElementById('respondInternal').checked;
            const markResolved = document.getElementById('respondResolved').checked;

            if (!token) {
                resultDiv.innerHTML = '<div class="error result">‚ùå Token wajib diisi!</div>';
                return;
            }

            if (!ticketId || !message) {
                resultDiv.innerHTML = '<div class="error result">‚ùå Ticket ID dan Pesan wajib diisi!</div>';
                return;
            }

            btn.disabled = true;
            resultDiv.innerHTML = '<div class="info result">‚è≥ Mengirim respon...</div>';

            try {
                const response = await fetch(`${API_URL}/ticket-actions/tickets/${ticketId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        is_internal: isInternal,
                        mark_resolved: markResolved
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    resultDiv.innerHTML = `
                        <div class="success result">
‚úÖ <strong>Respon Berhasil!</strong>

Response ID: ${data.data.id}
Ticket ID: ${data.data.ticket_id}
Responder ID: ${data.data.responder_id}
Type: ${data.data.response_type}
Internal: ${data.data.is_internal ? 'Ya' : 'Tidak'}

${data.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error result">
‚ùå <strong>Respon Gagal</strong>

Status: ${response.status}
Error: ${data.error || 'Unknown error'}

${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error result">
‚ùå <strong>Error:</strong>
${error.message}

Pastikan:
- Backend berjalan di port 3004
- Token valid
- Ticket ID ada di database
                    </div>
                `;
            } finally {
                btn.disabled = false;
            }
        }

        // Auto-fill token dari localStorage jika ada
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('escalateToken').value = token;
                document.getElementById('respondToken').value = token;
                console.log('‚úÖ Token auto-filled dari localStorage');
            }
        });
    </script>
</body>
</html>
