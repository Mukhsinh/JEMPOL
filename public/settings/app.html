<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Pengaturan Aplikasi - RSUD Sehat Sentosa</title>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"],
                        "sans": ["Public Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem", 
                        "lg": "0.5rem", 
                        "xl": "0.75rem", 
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display transition-colors duration-200">
    <div class="relative flex h-screen w-full overflow-hidden">
        <!-- Sidebar -->
        <aside class="flex w-72 flex-col border-r border-slate-200 bg-white dark:border-slate-800 dark:bg-[#111a22] transition-colors duration-200 flex-shrink-0">
            <div class="flex h-full flex-col justify-between p-4">
                <div class="flex flex-col gap-4">
                    <div class="flex gap-3 items-center px-2 py-2">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border border-slate-200 dark:border-slate-700" data-alt="Abstract medical cross logo with blue gradient" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCf_-Xr211EGVjCIhEGzSYTakMCAyD6oIECe0hLLqCQJ_KBnFlQyOT6n3LelD3IDeWAMVFMXKatrqhkJFKZY2raADMz9Hw306elO2jRru1GhLQQjBW_0yW59as_2DS6DBnEMPQl8CeJtuCycCPWdVCrhIvJQ0HI4-KNvzsVXyV4o-5caK_N_cfXe5gkRBdtE0mWv9uNszBzqf5DfUoYW3hvXF5LvB6QU9_v8Oa9iSlNkBYxJrttckeTSeehaNTdf_uwCehQ9dd1k5tl");'></div>
                        <div class="flex flex-col">
                            <h1 class="text-slate-900 dark:text-white text-base font-bold leading-normal">Admin Panel</h1>
                            <p class="text-slate-500 dark:text-slate-400 text-sm font-normal leading-normal">RSUD Sehat Sentosa</p>
                        </div>
                    </div>
                    <nav class="flex flex-col gap-2 mt-4">
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group" href="/dashboard">
                            <span class="material-symbols-outlined text-slate-500 group-hover:text-slate-900 dark:text-slate-400 dark:group-hover:text-white">grid_view</span>
                            <p class="text-slate-700 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white text-sm font-medium leading-normal">Dashboard</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group" href="/tickets">
                            <span class="material-symbols-outlined text-slate-500 group-hover:text-slate-900 dark:text-slate-400 dark:group-hover:text-white">inbox</span>
                            <p class="text-slate-700 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white text-sm font-medium leading-normal">Pengaduan Masuk</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group" href="/ai-analysis">
                            <span class="material-symbols-outlined text-slate-500 group-hover:text-slate-900 dark:text-slate-400 dark:group-hover:text-white">auto_awesome</span>
                            <p class="text-slate-700 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white text-sm font-medium leading-normal">Analisis AI</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group" href="/reports">
                            <span class="material-symbols-outlined text-slate-500 group-hover:text-slate-900 dark:text-slate-400 dark:group-hover:text-white">description</span>
                            <p class="text-slate-700 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white text-sm font-medium leading-normal">Laporan</p>
                        </a>
                        <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 dark:bg-primary/20">
                            <span class="material-symbols-outlined text-primary font-fill">settings</span>
                            <p class="text-primary text-sm font-bold leading-normal">Pengaturan</p>
                        </div>
                    </nav>
                </div>
                <div class="flex flex-col gap-2 border-t border-slate-200 dark:border-slate-800 pt-4">
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 group transition-colors" href="#" onclick="logout()">
                        <span class="material-symbols-outlined text-red-500">logout</span>
                        <p class="text-red-500 text-sm font-medium leading-normal">Keluar</p>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-background-light dark:bg-background-dark">
            <div class="flex-1 overflow-y-auto w-full">
                <div class="max-w-[1000px] mx-auto w-full px-6 py-8 md:px-10 md:py-10 pb-12">
                    <!-- Breadcrumbs -->
                    <nav aria-label="Breadcrumb" class="flex mb-6">
                        <ol class="flex items-center gap-2">
                            <li><a class="text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary transition-colors text-sm font-medium" href="/dashboard">Dashboard</a></li>
                            <li class="text-slate-400 dark:text-slate-600">/</li>
                            <li class="text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary transition-colors text-sm font-medium">Pengaturan</li>
                            <li class="text-slate-400 dark:text-slate-600">/</li>
                            <li aria-current="page" class="text-slate-900 dark:text-white text-sm font-semibold">Aplikasi</li>
                        </ol>
                    </nav>

                    <!-- Page Header -->
                    <div class="flex flex-col gap-2 mb-8">
                        <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-slate-900 dark:text-white">Pengaturan Aplikasi</h1>
                        <p class="text-slate-500 dark:text-slate-400 text-base max-w-2xl">Kelola identitas aplikasi utama dan detail organisasi. Informasi ini akan digunakan oleh sistem AI untuk header laporan dan respons otomatis.</p>
                    </div>

                    <!-- Loading State -->
                    <div id="loading" class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <span class="ml-3 text-slate-600 dark:text-slate-400">Memuat pengaturan...</span>
                    </div>

                    <!-- Form Container -->
                    <form class="flex flex-col gap-6 hidden" id="settings_form">
                        <!-- Logo Upload Section -->
                        <div class="bg-white dark:bg-[#1e2936] rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                            <div class="p-6">
                                <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-1">Logo Instansi</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Logo ini akan ditampilkan pada halaman login dan kop surat laporan.</p>
                                
                                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6">
                                    <!-- Logo Preview -->
                                    <div class="relative group shrink-0">
                                        <div class="w-32 h-32 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 flex items-center justify-center overflow-hidden relative" id="logo_preview">
                                            <div class="bg-contain bg-center bg-no-repeat w-full h-full p-2" data-alt="Current institution logo preview" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAIPfPjbYltqH_mTAVBlq5TBAyUxMT0Hm-P6yy0RHceBroIhncqoDRVdoZH_dJk-SOWg2-FxxKnp6ZZhYlb_GFzwwjeU4XME3R0bEVf5ueL7TRIGeo8F5GMdZSOfAyLppPewXBHpeS1j-ZhszqrOXF5axApjwYOWvOdotHxgV4AGdqEc_PFWyB8-3Br0QW796SfdYVyBuQaJr0HV4XpgZGuTJ9nIXR-WGBTVLxwDlU0R0hFX4WzqspqBGG5eb_bk9toxNBilomRS78A");'></div>
                                        </div>
                                    </div>

                                    <!-- Upload Controls -->
                                    <div class="flex flex-col gap-3">
                                        <div class="flex gap-3">
                                            <label class="inline-flex items-center justify-center px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors cursor-pointer">
                                                <span class="material-symbols-outlined text-[20px] mr-2">upload</span>
                                                Unggah Logo Baru
                                                <input type="file" accept="image/jpeg,image/png,image/svg+xml" id="logo_upload" class="hidden"/>
                                            </label>
                                            <button class="inline-flex items-center justify-center px-4 py-2 bg-transparent border border-transparent rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 focus:outline-none transition-colors" type="button" id="remove_logo">Hapus</button>
                                        </div>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Format file yang didukung: JPG, PNG, atau SVG. Ukuran maksimal 2MB. Dimensi yang disarankan 512x512px.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- General Info Form -->
                        <div class="bg-white dark:bg-[#1e2936] rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <div class="p-6 border-b border-slate-100 dark:border-slate-700/50">
                                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Informasi Umum</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Detail ini digunakan untuk identifikasi sistem.</p>
                            </div>
                            
                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Application Name -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="app_name">Nama Aplikasi</label>
                                    <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" id="app_name" name="app_name" type="text" value="Sistem Pengaduan Masyarakat Terpadu"/>
                                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Nama yang muncul di tab browser dan judul dashboard.</p>
                                </div>

                                <!-- Institution Name -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="inst_name">Nama Instansi</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">apartment</span>
                                        </div>
                                        <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="inst_name" name="inst_name" type="text" value="RSUD Sehat Sentosa"/>
                                    </div>
                                    <div class="mt-2 flex gap-2 items-start p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-xs text-blue-700 dark:text-blue-300">
                                        <span class="material-symbols-outlined text-[16px] shrink-0 mt-0.5">info</span>
                                        <span>Penting: Nama instansi digunakan oleh AI untuk men-generate surat tanggapan resmi secara otomatis.</span>
                                    </div>
                                </div>

                                <!-- Manager Name -->
                                <div class="col-span-1">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="manager_name">Nama Pengelola Utama</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">person</span>
                                        </div>
                                        <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="manager_name" name="manager_name" placeholder="Contoh: Dr. Budi Santoso" type="text"/>
                                    </div>
                                </div>

                                <!-- Job Title -->
                                <div class="col-span-1">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="job_title">Jabatan</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">badge</span>
                                        </div>
                                        <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="job_title" name="job_title" placeholder="Contoh: Kepala Bagian Humas" type="text"/>
                                    </div>
                                </div>

                                <!-- Manager Position -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="manager_position">Jabatan Pengelola</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">work</span>
                                        </div>
                                        <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="manager_position" name="manager_position" placeholder="Contoh: Kepala Bagian Humas" type="text"/>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="description">Deskripsi Instansi</label>
                                    <textarea class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" id="description" name="description" rows="3" placeholder="Deskripsi singkat tentang instansi..."></textarea>
                                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Deskripsi ini akan digunakan dalam laporan dan komunikasi resmi.</p>
                                </div>

                                <!-- Contact Information -->
                                <div class="col-span-1 md:col-span-2">
                                    <h3 class="text-base font-semibold text-slate-900 dark:text-white mb-4">Informasi Kontak</h3>
                                </div>

                                <!-- Address -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="address">Alamat Lengkap</label>
                                    <div class="relative">
                                        <div class="absolute top-3 left-0 pl-3 flex items-start pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">location_on</span>
                                        </div>
                                        <textarea class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="address" name="address" rows="3" placeholder="Jl. Contoh No. 123, Kelurahan ABC, Kecamatan XYZ, Kota/Kabupaten, Provinsi 12345"></textarea>
                                    </div>
                                </div>

                                <!-- Contact Email -->
                                <div class="col-span-1">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="contact_email">Email Kontak</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">email</span>
                                        </div>
                                        <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="contact_email" name="contact_email" type="email" placeholder="info@instansi.go.id"/>
                                    </div>
                                </div>

                                <!-- Contact Phone -->
                                <div class="col-span-1">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="contact_phone">Nomor Telepon</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">phone</span>
                                        </div>
                                        <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="contact_phone" name="contact_phone" type="tel" placeholder="(021) 1234-5678"/>
                                    </div>
                                </div>

                                <!-- Website -->
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5" for="website">Website Resmi</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="material-symbols-outlined text-slate-400 text-[20px]">language</span>
                                        </div>
                                        <input class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm pl-10 py-2.5 px-3" id="website" name="website" type="url" placeholder="https://www.instansi.go.id"/>
                                    </div>
                                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">URL lengkap website resmi instansi (termasuk https://).</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Actions Footer -->
            <div class="w-full bg-white dark:bg-[#1e2936] border-t border-slate-200 dark:border-slate-700 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 shrink-0 hidden" id="form_actions">
                <div class="max-w-[1000px] mx-auto w-full px-6 py-4 md:px-10 flex items-center justify-end gap-3">
                    <button class="px-5 py-2.5 text-sm font-medium text-slate-700 dark:text-slate-200 bg-white dark:bg-transparent border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors" type="button" onclick="window.history.back()">Batal</button>
                    <button class="px-5 py-2.5 text-sm font-bold text-white bg-primary rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary shadow-sm hover:shadow transition-all flex items-center gap-2" form="settings_form" type="submit" id="save_button">
                        <span class="material-symbols-outlined text-[18px]">save</span>
                        Simpan Perubahan
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global variables
        let currentSettings = {};
        let isLoading = false;

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            toast.textContent = message;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Get authentication token
        function getAuthToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        // API request helper
        async function apiRequest(url, options = {}) {
            const token = getAuthToken();
            
            // Ensure URL is properly formatted
            const apiUrl = url.startsWith('/') ? url : `/${url}`;
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showToast('Sesi telah berakhir. Silakan login kembali.', 'error');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                        throw new Error('Unauthorized');
                    }
                    
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                return response.json();
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }

        // Load settings from database
        async function loadSettings() {
            try {
                isLoading = true;
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('settings_form').classList.add('hidden');
                document.getElementById('form_actions').classList.add('hidden');

                console.log('Loading app settings...');
                const data = await apiRequest('/api/app-settings');
                console.log('App settings loaded:', data);
                
                // Convert array to object for easier access
                const settingsMap = {};
                if (Array.isArray(data)) {
                    data.forEach(setting => {
                        settingsMap[setting.setting_key] = setting.setting_value;
                    });
                } else {
                    console.warn('Expected array but got:', typeof data, data);
                    // If data is already an object, use it directly
                    Object.assign(settingsMap, data);
                }

                currentSettings = settingsMap;
                populateForm(settingsMap);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('settings_form').classList.remove('hidden');
                document.getElementById('form_actions').classList.remove('hidden');
                
                console.log('Settings form populated successfully');
                
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast(`Gagal memuat pengaturan aplikasi: ${error.message}`, 'error');
                document.getElementById('loading').classList.add('hidden');
                
                // Show error state
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-center py-12';
                errorDiv.innerHTML = `
                    <div class="text-red-500 mb-4">
                        <span class="material-symbols-outlined text-6xl">error</span>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">Gagal Memuat Pengaturan</h3>
                    <p class="text-slate-500 dark:text-slate-400 mb-4">${error.message}</p>
                    <button onclick="loadSettings()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                        Coba Lagi
                    </button>
                `;
                
                const container = document.querySelector('.max-w-\\[1000px\\]');
                if (container) {
                    container.appendChild(errorDiv);
                }
            } finally {
                isLoading = false;
            }
        }

        // Populate form with settings data
        function populateForm(settings) {
            console.log('Populating form with settings:', settings);
            
            try {
                // Basic information
                const appNameEl = document.getElementById('app_name');
                const instNameEl = document.getElementById('inst_name');
                const managerNameEl = document.getElementById('manager_name');
                const jobTitleEl = document.getElementById('job_title');
                const managerPositionEl = document.getElementById('manager_position');
                const descriptionEl = document.getElementById('description');
                
                if (appNameEl) appNameEl.value = settings.app_name || 'Sistem Pengaduan Masyarakat Terpadu';
                if (instNameEl) instNameEl.value = settings.institution_name || 'RSUD Sehat Sentosa';
                if (managerNameEl) managerNameEl.value = settings.manager_name || '';
                if (jobTitleEl) jobTitleEl.value = settings.job_title || '';
                if (managerPositionEl) managerPositionEl.value = settings.manager_position || '';
                if (descriptionEl) descriptionEl.value = settings.description || '';
                
                // Contact information
                const addressEl = document.getElementById('address');
                const contactEmailEl = document.getElementById('contact_email');
                const contactPhoneEl = document.getElementById('contact_phone');
                const websiteEl = document.getElementById('website');
                
                if (addressEl) addressEl.value = settings.address || '';
                if (contactEmailEl) contactEmailEl.value = settings.contact_email || '';
                if (contactPhoneEl) contactPhoneEl.value = settings.contact_phone || '';
                if (websiteEl) websiteEl.value = settings.website || '';

                // Logo handling
                const logoUrl = settings.logo_url || settings.institution_logo;
                if (logoUrl) {
                    updateLogoPreview(logoUrl);
                }
                
                console.log('Form populated successfully');
            } catch (error) {
                console.error('Error populating form:', error);
                showToast('Gagal mengisi form dengan data pengaturan', 'error');
            }
        }

        // Update logo preview
        function updateLogoPreview(logoUrl) {
            const preview = document.getElementById('logo_preview');
            if (logoUrl) {
                preview.innerHTML = `<img src="${logoUrl}" alt="Logo Instansi" class="w-full h-full object-contain p-2">`;
            } else {
                preview.innerHTML = `
                    <div class="text-slate-400 text-center">
                        <span class="material-symbols-outlined text-4xl mb-2 block">image</span>
                        <span class="text-xs">Belum ada logo</span>
                    </div>
                `;
            }
        }

        // Handle logo upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Ukuran file maksimal 2MB', 'error');
                return;
            }

            // Validate file type
            if (!['image/jpeg', 'image/png', 'image/svg+xml'].includes(file.type)) {
                showToast('Format file harus JPG, PNG, atau SVG', 'error');
                return;
            }

            // Convert to base64 for preview and storage
            const reader = new FileReader();
            reader.onload = (e) => {
                const result = e.target.result;
                updateLogoPreview(result);
                currentSettings.logo_url = result;
                showToast('Logo berhasil diunggah');
            };
            reader.readAsDataURL(file);
        }

        // Handle logo removal
        function handleLogoRemoval() {
            updateLogoPreview('');
            currentSettings.logo_url = '';
            document.getElementById('logo_upload').value = '';
            showToast('Logo berhasil dihapus');
        }

        // Save settings to database
        async function saveSettings(event) {
            event.preventDefault();
            
            if (isLoading) return;

            try {
                isLoading = true;
                const saveButton = document.getElementById('save_button');
                saveButton.disabled = true;
                saveButton.innerHTML = `
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    Menyimpan...
                `;

                // Collect form data
                const formData = {
                    app_name: document.getElementById('app_name').value,
                    institution_name: document.getElementById('inst_name').value,
                    manager_name: document.getElementById('manager_name').value,
                    job_title: document.getElementById('job_title').value,
                    manager_position: document.getElementById('manager_position').value,
                    description: document.getElementById('description').value,
                    address: document.getElementById('address').value,
                    contact_email: document.getElementById('contact_email').value,
                    contact_phone: document.getElementById('contact_phone').value,
                    website: document.getElementById('website').value,
                    logo_url: currentSettings.logo_url || ''
                };

                await apiRequest('/api/app-settings', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                showToast('Pengaturan aplikasi berhasil disimpan');
                
                // Update current settings
                currentSettings = { ...currentSettings, ...formData };
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Gagal menyimpan pengaturan aplikasi', 'error');
            } finally {
                isLoading = false;
                const saveButton = document.getElementById('save_button');
                saveButton.disabled = false;
                saveButton.innerHTML = `
                    <span class="material-symbols-outlined text-[18px]">save</span>
                    Simpan Perubahan
                `;
            }
        }

        // Logout function
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                localStorage.removeItem('token');
                sessionStorage.removeItem('token');
                window.location.href = '/login';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing app settings page');
            
            // Check authentication
            const token = getAuthToken();
            console.log('Authentication token:', token ? 'Found' : 'Not found');
            
            if (!token) {
                console.warn('No authentication token found, redirecting to login');
                showToast('Sesi tidak ditemukan. Silakan login terlebih dahulu.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }

            console.log('Token found, loading settings...');
            
            // Load settings
            loadSettings();

            // Event listeners
            const settingsForm = document.getElementById('settings_form');
            const logoUpload = document.getElementById('logo_upload');
            const removeLogo = document.getElementById('remove_logo');
            
            if (settingsForm) {
                settingsForm.addEventListener('submit', saveSettings);
                console.log('Settings form event listener added');
            }
            
            if (logoUpload) {
                logoUpload.addEventListener('change', handleLogoUpload);
                console.log('Logo upload event listener added');
            }
            
            if (removeLogo) {
                removeLogo.addEventListener('click', handleLogoRemoval);
                console.log('Remove logo event listener added');
            }

            // Auto-save on input change (debounced)
            let saveTimeout;
            const inputs = document.querySelectorAll('#settings_form input, #settings_form textarea');
            console.log(`Found ${inputs.length} form inputs for auto-save`);
            
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        // Auto-save could be implemented here if needed
                        console.log('Auto-save triggered for:', input.name || input.id);
                    }, 2000);
                });
            });
            
            console.log('App settings page initialization complete');
        });
    </script>
</body>
</html>