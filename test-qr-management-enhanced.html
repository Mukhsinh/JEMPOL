<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Management - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">Test QR Management - Enhanced Features</h1>
        
        <!-- Test Results -->
        <div id="results" class="space-y-4 mb-6"></div>
        
        <!-- QR Codes List -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">QR Codes List</h2>
            <div id="qrList" class="space-y-3"></div>
        </div>
        
        <!-- Test Actions -->
        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Test Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="testGetQRCodes()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Load QR Codes
                </button>
                <button onclick="testToggleStatus()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    Test Toggle Status
                </button>
                <button onclick="testDeleteQRCode()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Test Delete QR Code
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let qrCodes = [];
        let authToken = null;

        // Get auth token from localStorage or prompt
        function getAuthToken() {
            if (!authToken) {
                authToken = localStorage.getItem('authToken') || prompt('Enter auth token:');
                if (authToken) {
                    localStorage.setItem('authToken', authToken);
                }
            }
            return authToken;
        }

        // API call helper
        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`HTTP ${response.status}: ${error}`);
            }
            
            return response.json();
        }

        // Add result to display
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-blue-100 text-blue-800'
            }`;
            div.innerHTML = `
                <div class="flex items-center">
                    <span class="material-symbols-outlined mr-2">
                        ${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}
                    </span>
                    ${message}
                </div>
            `;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // Test: Get QR Codes
        async function testGetQRCodes() {
            try {
                addResult('Loading QR codes...', 'info');
                const data = await apiCall('/qr-codes?include_analytics=true');
                qrCodes = data.qr_codes || [];
                
                addResult(`✅ Loaded ${qrCodes.length} QR codes successfully`, 'success');
                displayQRCodes();
            } catch (error) {
                addResult(`❌ Error loading QR codes: ${error.message}`, 'error');
            }
        }

        // Display QR codes in the list
        function displayQRCodes() {
            const qrList = document.getElementById('qrList');
            qrList.innerHTML = '';
            
            if (qrCodes.length === 0) {
                qrList.innerHTML = '<p class="text-gray-500">No QR codes found</p>';
                return;
            }
            
            qrCodes.forEach(qr => {
                const div = document.createElement('div');
                div.className = 'border rounded-lg p-4 flex items-center justify-between';
                div.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
                            <span class="material-symbols-outlined text-gray-600">qr_code</span>
                        </div>
                        <div>
                            <h3 class="font-semibold">${qr.name}</h3>
                            <p class="text-sm text-gray-600">Code: ${qr.code}</p>
                            <p class="text-sm text-gray-600">Unit: ${qr.units?.name || 'N/A'}</p>
                            <p class="text-sm text-gray-600">Usage: ${qr.usage_count || 0} scans</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            qr.is_active 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-gray-100 text-gray-800'
                        }">
                            ${qr.is_active ? 'Active' : 'Inactive'}
                        </span>
                        <button onclick="toggleQRStatus('${qr.id}', ${qr.is_active})" 
                                class="p-2 text-gray-400 hover:text-blue-600 rounded">
                            <span class="material-symbols-outlined">
                                ${qr.is_active ? 'toggle_on' : 'toggle_off'}
                            </span>
                        </button>
                        <button onclick="deleteQRCode('${qr.id}', '${qr.name}')" 
                                class="p-2 text-gray-400 hover:text-red-600 rounded">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                `;
                qrList.appendChild(div);
            });
        }

        // Toggle QR Code status
        async function toggleQRStatus(id, currentStatus) {
            try {
                addResult(`Toggling QR code status...`, 'info');
                
                const response = await apiCall(`/qr-codes/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        is_active: !currentStatus
                    })
                });
                
                addResult(`✅ QR code status updated successfully`, 'success');
                
                // Update local data
                const qrIndex = qrCodes.findIndex(qr => qr.id === id);
                if (qrIndex !== -1) {
                    qrCodes[qrIndex].is_active = !currentStatus;
                    displayQRCodes();
                }
            } catch (error) {
                addResult(`❌ Error updating QR code status: ${error.message}`, 'error');
            }
        }

        // Delete QR Code
        async function deleteQRCode(id, name) {
            if (!confirm(`Are you sure you want to delete QR Code "${name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                addResult(`Deleting QR code "${name}"...`, 'info');
                
                await apiCall(`/qr-codes/${id}`, {
                    method: 'DELETE'
                });
                
                addResult(`✅ QR code "${name}" deleted successfully`, 'success');
                
                // Remove from local data
                qrCodes = qrCodes.filter(qr => qr.id !== id);
                displayQRCodes();
            } catch (error) {
                addResult(`❌ Error deleting QR code: ${error.message}`, 'error');
            }
        }

        // Test toggle status with first active QR code
        async function testToggleStatus() {
            const activeQR = qrCodes.find(qr => qr.is_active);
            if (activeQR) {
                await toggleQRStatus(activeQR.id, activeQR.is_active);
            } else {
                addResult('No active QR codes found to test toggle', 'error');
            }
        }

        // Test delete with confirmation
        async function testDeleteQRCode() {
            // Find a QR code that doesn't have associated tickets
            const qrToDelete = qrCodes.find(qr => qr.usage_count === 0);
            if (qrToDelete) {
                await deleteQRCode(qrToDelete.id, qrToDelete.name);
            } else {
                addResult('No unused QR codes found for safe deletion test', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addResult('QR Management Enhanced Test initialized', 'info');
            testGetQRCodes();
        });
    </script>
</body>
</html>