<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test App Settings Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">Test App Settings Integration</h1>
        
        <!-- Status Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Status Koneksi</h2>
            <div id="connectionStatus" class="flex items-center gap-2">
                <span class="material-symbols-outlined text-gray-400">pending</span>
                <span>Checking connection...</span>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="testHealthCheck()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Health Check
                </button>
                <button onclick="testGetPublicSettings()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Get Public Settings
                </button>
                <button onclick="testGetAllSettings()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Get All Settings
                </button>
                <button onclick="testUpdateSettings()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    Update Settings
                </button>
                <button onclick="clearResults()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Clear Results
                </button>
                <button onclick="runAllTests()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Run All Tests
                </button>
            </div>
        </div>

        <!-- Current Settings Display -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Current Settings</h2>
            <div id="currentSettings" class="bg-gray-50 p-4 rounded">
                <p class="text-gray-500">No settings loaded yet</p>
            </div>
        </div>

        <!-- Test Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Update Settings Form</h2>
            <form id="settingsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Aplikasi</label>
                    <input type="text" id="app_name" name="app_name" class="w-full border border-gray-300 rounded px-3 py-2" 
                           value="Sistem Pengaduan Masyarakat Terpadu">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Instansi</label>
                    <input type="text" id="institution_name" name="institution_name" class="w-full border border-gray-300 rounded px-3 py-2" 
                           value="RSUD Sehat Sentosa">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pengelola</label>
                    <input type="text" id="manager_name" name="manager_name" class="w-full border border-gray-300 rounded px-3 py-2" 
                           placeholder="Dr. Budi Santoso">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                    <input type="text" id="job_title" name="job_title" class="w-full border border-gray-300 rounded px-3 py-2" 
                           placeholder="Kepala Bagian Humas">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Logo URL</label>
                    <input type="text" id="logo_url" name="logo_url" class="w-full border border-gray-300 rounded px-3 py-2" 
                           placeholder="https://example.com/logo.png">
                </div>
                <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                    Update Settings
                </button>
            </form>
        </div>

        <!-- Results Panel -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="results" class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto">
                <p class="text-gray-500">No test results yet</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        // Mock token untuk testing
        const TEST_TOKEN = 'test-token-123';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-2 ${color}`;
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            
            results.appendChild(logEntry);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '<p class="text-gray-500">Results cleared</p>';
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            const icon = statusEl.querySelector('.material-symbols-outlined');
            const text = statusEl.querySelector('span:last-child');
            
            if (status === 'success') {
                icon.textContent = 'check_circle';
                icon.className = 'material-symbols-outlined text-green-500';
            } else if (status === 'error') {
                icon.textContent = 'error';
                icon.className = 'material-symbols-outlined text-red-500';
            } else {
                icon.textContent = 'pending';
                icon.className = 'material-symbols-outlined text-yellow-500';
            }
            
            text.textContent = message;
        }

        function displaySettings(settings) {
            const settingsEl = document.getElementById('currentSettings');
            if (settings && Object.keys(settings).length > 0) {
                settingsEl.innerHTML = '<pre class="text-sm">' + JSON.stringify(settings, null, 2) + '</pre>';
            } else {
                settingsEl.innerHTML = '<p class="text-gray-500">No settings available</p>';
            }
        }

        async function testHealthCheck() {
            log('ðŸ§ª Testing server health...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… Server health check berhasil: ' + JSON.stringify(data), 'success');
                    updateConnectionStatus('success', 'Server connected');
                    return true;
                } else {
                    log('âŒ Server health check gagal: ' + JSON.stringify(data), 'error');
                    updateConnectionStatus('error', 'Server error');
                    return false;
                }
            } catch (error) {
                log('âŒ Error health check: ' + error.message, 'error');
                updateConnectionStatus('error', 'Connection failed');
                return false;
            }
        }

        async function testGetPublicSettings() {
            log('ðŸ§ª Testing GET /api/app-settings/public...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/app-settings/public`);
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… GET public settings berhasil: ' + JSON.stringify(data), 'success');
                    displaySettings(data);
                    return data;
                } else {
                    log('âŒ GET public settings gagal: ' + JSON.stringify(data), 'error');
                    return null;
                }
            } catch (error) {
                log('âŒ Error GET public settings: ' + error.message, 'error');
                return null;
            }
        }

        async function testGetAllSettings() {
            log('ðŸ§ª Testing GET /api/app-settings...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/app-settings`, {
                    headers: {
                        'Authorization': `Bearer ${TEST_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… GET all settings berhasil: ' + JSON.stringify(data), 'success');
                    displaySettings(data);
                    
                    // Update form with current values
                    if (Array.isArray(data)) {
                        data.forEach(setting => {
                            const input = document.getElementById(setting.setting_key);
                            if (input) {
                                input.value = setting.setting_value || '';
                            }
                        });
                    }
                    
                    return data;
                } else {
                    log('âŒ GET all settings gagal: ' + JSON.stringify(data), 'error');
                    return null;
                }
            } catch (error) {
                log('âŒ Error GET all settings: ' + error.message, 'error');
                return null;
            }
        }

        async function testUpdateSettings() {
            log('ðŸ§ª Testing POST /api/app-settings...', 'info');
            
            const formData = new FormData(document.getElementById('settingsForm'));
            const settings = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE}/app-settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${TEST_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('âœ… POST settings berhasil: ' + JSON.stringify(data), 'success');
                    return data;
                } else {
                    log('âŒ POST settings gagal: ' + JSON.stringify(data), 'error');
                    return null;
                }
            } catch (error) {
                log('âŒ Error POST settings: ' + error.message, 'error');
                return null;
            }
        }

        async function runAllTests() {
            log('ðŸš€ Running all tests...', 'info');
            
            const isHealthy = await testHealthCheck();
            if (!isHealthy) {
                log('âŒ Server tidak sehat, menghentikan test', 'error');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await testGetPublicSettings();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await testGetAllSettings();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await testUpdateSettings();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            log('âœ¨ All tests completed!', 'success');
        }

        // Form submission handler
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            testUpdateSettings();
        });

        // Auto-run health check on page load
        window.addEventListener('load', function() {
            setTimeout(testHealthCheck, 1000);
        });
    </script>
</body>
</html>