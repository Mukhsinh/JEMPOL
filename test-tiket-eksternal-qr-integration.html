<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Integrasi Tiket Eksternal & QR Code</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f0fff0; }
        .error { border-color: #f44336; background-color: #fff0f0; }
        .info { border-color: #2196F3; background-color: #f0f8ff; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .qr-display {
            text-align: center;
            padding: 20px;
            border: 2px dashed #ccc;
            margin: 10px 0;
        }
        .qr-display img {
            max-width: 200px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Integrasi Tiket Eksternal & QR Code</h1>
    
    <!-- Test 1: Load Service Categories from Master Data -->
    <div class="container">
        <h2>1. Test Master Data - Service Categories</h2>
        <div class="test-section info">
            <p>Memuat kategori layanan dari tabel master data</p>
            <button onclick="testServiceCategories()">Load Service Categories</button>
            <div id="categoriesResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <!-- Test 2: QR Code Management -->
    <div class="container">
        <h2>2. Test QR Code Management</h2>
        <div class="test-section info">
            <h3>Create QR Code</h3>
            <div class="form-group">
                <label>Unit ID:</label>
                <select id="unitSelect">
                    <option value="">Loading units...</option>
                </select>
            </div>
            <div class="form-group">
                <label>QR Name:</label>
                <input type="text" id="qrName" value="Test QR - IGD Loket 1" />
            </div>
            <div class="form-group">
                <label>Description:</label>
                <textarea id="qrDescription">QR Code untuk pengaduan di IGD Loket 1</textarea>
            </div>
            <button onclick="createQRCode()">Create QR Code</button>
            <div id="qrCreateResult" class="result" style="display:none;"></div>
            <div id="qrDisplay" class="qr-display" style="display:none;">
                <h4>Generated QR Code:</h4>
                <div id="qrImageContainer"></div>
                <p id="qrUrl"></p>
            </div>
        </div>

        <div class="test-section info">
            <h3>Test QR Code Scan</h3>
            <div class="form-group">
                <label>QR Code:</label>
                <input type="text" id="qrCodeToScan" placeholder="Enter QR code to test" />
            </div>
            <button onclick="testQRScan()">Test QR Scan</button>
            <div id="qrScanResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <!-- Test 3: External Ticket Creation -->
    <div class="container">
        <h2>3. Test External Ticket Creation</h2>
        <div class="test-section info">
            <h3>Create External Ticket (with QR Code)</h3>
            <div class="form-group">
                <label>QR Code ID (optional):</label>
                <input type="text" id="ticketQrCodeId" placeholder="Leave empty for no QR" />
            </div>
            <div class="form-group">
                <label>Unit ID:</label>
                <select id="ticketUnitSelect">
                    <option value="">Select unit...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reporter Type:</label>
                <select id="reporterType">
                    <option value="personal">Personal</option>
                    <option value="anonymous">Anonymous</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reporter Name:</label>
                <input type="text" id="reporterName" value="John Doe" />
            </div>
            <div class="form-group">
                <label>Reporter Email:</label>
                <input type="email" id="reporterEmail" value="john@example.com" />
            </div>
            <div class="form-group">
                <label>Service Type:</label>
                <select id="serviceType">
                    <option value="complaint">Complaint</option>
                    <option value="request">Request</option>
                    <option value="suggestion">Suggestion</option>
                    <option value="survey">Survey</option>
                </select>
            </div>
            <div class="form-group">
                <label>Category:</label>
                <select id="ticketCategory">
                    <option value="">Select category...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Title:</label>
                <input type="text" id="ticketTitle" value="Test Pengaduan AC Rusak" />
            </div>
            <div class="form-group">
                <label>Description:</label>
                <textarea id="ticketDescription">AC di ruang tunggu IGD tidak berfungsi dengan baik. Suhu ruangan sangat panas dan membuat pasien tidak nyaman.</textarea>
            </div>
            <button onclick="createExternalTicket()">Create External Ticket</button>
            <div id="ticketCreateResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <!-- Test 4: Integration Test -->
    <div class="container">
        <h2>4. Full Integration Test</h2>
        <div class="test-section info">
            <p>Test complete flow: Create QR ‚Üí Scan QR ‚Üí Create Ticket via QR</p>
            <button onclick="runFullIntegrationTest()">Run Full Integration Test</button>
            <div id="integrationResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = null;
        let availableUnits = [];
        let availableCategories = [];
        let createdQRCode = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUnits();
            testServiceCategories();
        });

        // Helper function to make API calls
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.error || data.message || 'Unknown error'}`);
                }
                
                return { success: true, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Load units for dropdowns
        async function loadUnits() {
            const result = await apiCall('/units');
            if (result.success) {
                availableUnits = result.data;
                populateUnitDropdowns();
            } else {
                console.error('Failed to load units:', result.error);
            }
        }

        function populateUnitDropdowns() {
            const selects = ['unitSelect', 'ticketUnitSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select unit...</option>';
                availableUnits.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = `${unit.name} (${unit.code})`;
                    select.appendChild(option);
                });
            });
        }

        // Test 1: Service Categories
        async function testServiceCategories() {
            const resultDiv = document.getElementById('categoriesResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Loading service categories...';

            const result = await apiCall('/master-data/service-categories');
            
            if (result.success) {
                availableCategories = result.data;
                resultDiv.textContent = `‚úÖ Loaded ${result.data.length} service categories:\n\n` + 
                    JSON.stringify(result.data, null, 2);
                
                // Populate category dropdown
                const categorySelect = document.getElementById('ticketCategory');
                categorySelect.innerHTML = '<option value="">Select category...</option>';
                result.data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                resultDiv.parentElement.className = 'test-section success';
            } else {
                resultDiv.textContent = `‚ùå Error loading service categories:\n${result.error}`;
                resultDiv.parentElement.className = 'test-section error';
            }
        }

        // Test 2: QR Code Creation
        async function createQRCode() {
            const resultDiv = document.getElementById('qrCreateResult');
            const qrDisplay = document.getElementById('qrDisplay');
            
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Creating QR code...';

            const unitId = document.getElementById('unitSelect').value;
            const name = document.getElementById('qrName').value;
            const description = document.getElementById('qrDescription').value;

            if (!unitId || !name) {
                resultDiv.textContent = '‚ùå Please select unit and enter QR name';
                resultDiv.parentElement.className = 'test-section error';
                return;
            }

            const result = await apiCall('/qr-codes', {
                method: 'POST',
                body: JSON.stringify({
                    unit_id: unitId,
                    name: name,
                    description: description
                })
            });

            if (result.success) {
                createdQRCode = result.data.qr_code;
                resultDiv.textContent = `‚úÖ QR Code created successfully:\n\n` + 
                    JSON.stringify(result.data, null, 2);
                
                // Display QR code
                qrDisplay.style.display = 'block';
                const qrImageContainer = document.getElementById('qrImageContainer');
                const qrUrl = document.getElementById('qrUrl');
                
                qrImageContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(result.data.qr_url)}" alt="QR Code" />`;
                qrUrl.textContent = `URL: ${result.data.qr_url}`;
                
                // Auto-fill scan test
                document.getElementById('qrCodeToScan').value = createdQRCode.code;
                document.getElementById('ticketQrCodeId').value = createdQRCode.id;
                
                resultDiv.parentElement.className = 'test-section success';
            } else {
                resultDiv.textContent = `‚ùå Error creating QR code:\n${result.error}`;
                resultDiv.parentElement.className = 'test-section error';
            }
        }

        // Test QR Code Scan
        async function testQRScan() {
            const resultDiv = document.getElementById('qrScanResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing QR scan...';

            const qrCode = document.getElementById('qrCodeToScan').value;
            if (!qrCode) {
                resultDiv.textContent = '‚ùå Please enter QR code to test';
                resultDiv.parentElement.className = 'test-section error';
                return;
            }

            const result = await apiCall(`/qr-codes/scan/${qrCode}`);

            if (result.success) {
                resultDiv.textContent = `‚úÖ QR Code scan successful:\n\n` + 
                    JSON.stringify(result.data, null, 2);
                resultDiv.parentElement.className = 'test-section success';
            } else {
                resultDiv.textContent = `‚ùå Error scanning QR code:\n${result.error}`;
                resultDiv.parentElement.className = 'test-section error';
            }
        }

        // Test 3: External Ticket Creation
        async function createExternalTicket() {
            const resultDiv = document.getElementById('ticketCreateResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Creating external ticket...';

            const formData = {
                qr_code_id: document.getElementById('ticketQrCodeId').value || undefined,
                unit_id: document.getElementById('ticketUnitSelect').value,
                reporter_identity_type: document.getElementById('reporterType').value,
                reporter_name: document.getElementById('reporterName').value,
                reporter_email: document.getElementById('reporterEmail').value,
                service_type: document.getElementById('serviceType').value,
                category: document.getElementById('ticketCategory').value,
                title: document.getElementById('ticketTitle').value,
                description: document.getElementById('ticketDescription').value
            };

            // Validate required fields
            if (!formData.unit_id || !formData.service_type || !formData.title || !formData.description) {
                resultDiv.textContent = '‚ùå Please fill in all required fields';
                resultDiv.parentElement.className = 'test-section error';
                return;
            }

            const result = await apiCall('/external-tickets', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (result.success) {
                resultDiv.textContent = `‚úÖ External ticket created successfully:\n\n` + 
                    JSON.stringify(result.data, null, 2);
                resultDiv.parentElement.className = 'test-section success';
            } else {
                resultDiv.textContent = `‚ùå Error creating external ticket:\n${result.error}`;
                resultDiv.parentElement.className = 'test-section error';
            }
        }

        // Test 4: Full Integration Test
        async function runFullIntegrationTest() {
            const resultDiv = document.getElementById('integrationResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Running full integration test...\n\n';

            let log = '';

            try {
                // Step 1: Load service categories
                log += '1. Loading service categories...\n';
                const categoriesResult = await apiCall('/master-data/service-categories');
                if (!categoriesResult.success) {
                    throw new Error(`Failed to load categories: ${categoriesResult.error}`);
                }
                log += `   ‚úÖ Loaded ${categoriesResult.data.length} categories\n\n`;

                // Step 2: Create QR code
                log += '2. Creating QR code...\n';
                const qrResult = await apiCall('/qr-codes', {
                    method: 'POST',
                    body: JSON.stringify({
                        unit_id: availableUnits[0]?.id,
                        name: 'Integration Test QR',
                        description: 'QR code for integration testing'
                    })
                });
                if (!qrResult.success) {
                    throw new Error(`Failed to create QR: ${qrResult.error}`);
                }
                log += `   ‚úÖ QR Code created: ${qrResult.data.qr_code.code}\n\n`;

                // Step 3: Scan QR code
                log += '3. Scanning QR code...\n';
                const scanResult = await apiCall(`/qr-codes/scan/${qrResult.data.qr_code.code}`);
                if (!scanResult.success) {
                    throw new Error(`Failed to scan QR: ${scanResult.error}`);
                }
                log += `   ‚úÖ QR scan successful for unit: ${scanResult.data.units.name}\n\n`;

                // Step 4: Create ticket via QR
                log += '4. Creating ticket via QR...\n';
                const ticketResult = await apiCall('/external-tickets', {
                    method: 'POST',
                    body: JSON.stringify({
                        qr_code_id: qrResult.data.qr_code.id,
                        unit_id: scanResult.data.unit_id,
                        reporter_identity_type: 'personal',
                        reporter_name: 'Integration Test User',
                        reporter_email: 'test@example.com',
                        service_type: 'complaint',
                        category: categoriesResult.data[0]?.id,
                        title: 'Integration Test Complaint',
                        description: 'This is a test complaint created during integration testing.'
                    })
                });
                if (!ticketResult.success) {
                    throw new Error(`Failed to create ticket: ${ticketResult.error}`);
                }
                log += `   ‚úÖ Ticket created: ${ticketResult.data.ticket_number}\n\n`;

                log += 'üéâ FULL INTEGRATION TEST PASSED!\n\n';
                log += 'Summary:\n';
                log += `- Service categories loaded: ${categoriesResult.data.length}\n`;
                log += `- QR code created: ${qrResult.data.qr_code.code}\n`;
                log += `- QR scan successful: ${scanResult.data.units.name}\n`;
                log += `- Ticket created: ${ticketResult.data.ticket_number}\n`;

                resultDiv.textContent = log;
                resultDiv.parentElement.className = 'test-section success';

            } catch (error) {
                log += `\n‚ùå INTEGRATION TEST FAILED: ${error.message}`;
                resultDiv.textContent = log;
                resultDiv.parentElement.className = 'test-section error';
            }
        }
    </script>
</body>
</html>