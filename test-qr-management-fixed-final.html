<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Management - Tombol Hapus & Aktifkan/Nonaktifkan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Test QR Management - Fungsi Hapus & Toggle Status</h1>
            
            <!-- Test Results -->
            <div id="testResults" class="space-y-4 mb-8">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-semibold text-blue-800">Status Test:</h3>
                    <div id="testStatus" class="text-blue-700">Memulai test...</div>
                </div>
            </div>

            <!-- QR Code List Simulation -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-gray-800 mb-4">Simulasi QR Management Interface</h3>
                
                <!-- Header -->
                <div class="hidden md:grid grid-cols-12 gap-4 px-6 py-3 text-xs font-semibold uppercase tracking-wider text-gray-500 border-b border-gray-200 mb-2">
                    <div class="col-span-4">Detail Unit</div>
                    <div class="col-span-2">QR Code</div>
                    <div class="col-span-2">Performa (30 Hari)</div>
                    <div class="col-span-2">Status</div>
                    <div class="col-span-2 text-right">Aksi</div>
                </div>

                <!-- QR Code Items -->
                <div id="qrCodeList" class="space-y-3">
                    <!-- Items will be populated by JavaScript -->
                </div>
            </div>

            <!-- Test Controls -->
            <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800 mb-4">Test Controls</h3>
                <div class="flex gap-4">
                    <button onclick="testToggleStatus()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Test Toggle Status
                    </button>
                    <button onclick="testDeleteFunction()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        Test Delete Function
                    </button>
                    <button onclick="testCreateQR()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        Test Create QR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock QR Code data
        let qrCodes = [
            {
                id: '1',
                name: 'QR Pelayanan Publik',
                code: 'QR-YANPUB',
                is_active: true,
                usage_count: 25,
                units: { name: 'Bagian Pelayanan Publik', code: 'YANPUB' },
                analytics: { scans_30d: 25, tickets_30d: 8, trend: [2, 4, 3, 5, 4] }
            },
            {
                id: '2',
                name: 'QR Informasi',
                code: 'QR-INFO',
                is_active: false,
                usage_count: 12,
                units: { name: 'Sub Bagian Informasi', code: 'INFO' },
                analytics: { scans_30d: 12, tickets_30d: 3, trend: [1, 2, 1, 3, 2] }
            },
            {
                id: '3',
                name: 'QR Pengaduan',
                code: 'QR-PENGADUAN',
                is_active: true,
                usage_count: 45,
                units: { name: 'Sub Bagian Pengaduan', code: 'PENGADUAN' },
                analytics: { scans_30d: 45, tickets_30d: 15, trend: [5, 8, 6, 9, 7] }
            }
        ];

        // Mock API functions
        const mockAPI = {
            updateQRCode: async (id, data) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const qr = qrCodes.find(q => q.id === id);
                        if (qr) {
                            Object.assign(qr, data);
                            resolve({ success: true, message: 'QR Code berhasil diperbarui' });
                        } else {
                            reject(new Error('QR Code tidak ditemukan'));
                        }
                    }, 500);
                });
            },

            deleteQRCode: async (id) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const index = qrCodes.findIndex(q => q.id === id);
                        if (index !== -1) {
                            // Simulate check for existing tickets
                            if (qrCodes[index].usage_count > 30) {
                                reject(new Error('QR Code tidak dapat dihapus karena sudah digunakan untuk tiket'));
                            } else {
                                qrCodes.splice(index, 1);
                                resolve({ success: true, message: 'QR Code berhasil dihapus' });
                            }
                        } else {
                            reject(new Error('QR Code tidak ditemukan'));
                        }
                    }, 500);
                });
            },

            createQRCode: async (data) => {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const newQR = {
                            id: Date.now().toString(),
                            name: data.name,
                            code: `QR-${Date.now()}`,
                            is_active: true,
                            usage_count: 0,
                            units: { name: 'Unit Baru', code: 'NEW' },
                            analytics: { scans_30d: 0, tickets_30d: 0, trend: [0, 0, 0, 0, 0] }
                        };
                        qrCodes.push(newQR);
                        resolve({ success: true, qr_code: newQR });
                    }, 500);
                });
            }
        };

        // UI Functions
        function getStatusBadge(isActive) {
            if (isActive) {
                return `
                    <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-200">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        Aktif
                    </div>
                `;
            } else {
                return `
                    <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                        Tidak Aktif
                    </div>
                `;
            }
        }

        function generateSparkline(trend) {
            const maxValue = Math.max(...trend, 1);
            return trend.map((value, index) => 
                `<div class="w-1 bg-green-500 rounded-t-sm" style="height: ${(value / maxValue) * 100}%"></div>`
            ).join('');
        }

        function renderQRCodes() {
            const container = document.getElementById('qrCodeList');
            container.innerHTML = qrCodes.map(qrCode => `
                <div class="group relative bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-blue-300 transition-all p-4 md:p-0 md:grid md:grid-cols-12 md:gap-4 md:items-center">
                    <!-- Unit Details -->
                    <div class="col-span-4 md:pl-6 md:py-4">
                        <div class="flex items-center gap-4">
                            <div class="hidden sm:flex w-10 h-10 rounded-lg bg-blue-100 text-blue-600 items-center justify-center shrink-0">
                                <span class="material-symbols-outlined">business</span>
                            </div>
                            <div>
                                <h3 class="text-base font-bold text-gray-900 group-hover:text-blue-600 transition-colors">
                                    ${qrCode.name}
                                </h3>
                                <p class="text-sm text-gray-500">
                                    ${qrCode.units.name}
                                </p>
                                <span class="md:hidden text-xs text-gray-400 mt-1 block">
                                    ID: ${qrCode.code}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- QR Preview -->
                    <div class="col-span-2 md:py-4 flex items-center gap-3">
                        <div class="w-12 h-12 bg-white p-1 rounded border border-gray-200 shrink-0">
                            <div class="w-full h-full bg-gray-100 rounded flex items-center justify-center">
                                <span class="material-symbols-outlined text-gray-400 text-sm">qr_code</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <button class="text-xs font-medium text-blue-600 hover:underline text-left">
                                Lihat
                            </button>
                            <button class="text-xs font-medium text-gray-500 hover:text-gray-800 text-left flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">content_copy</span>
                                Salin Link
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="col-span-2 md:py-4 mt-4 md:mt-0">
                        <div class="flex items-center gap-4">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Scan</p>
                                <p class="text-lg font-bold text-gray-900">
                                    ${qrCode.analytics.scans_30d}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Tiket</p>
                                <p class="text-lg font-bold text-gray-900">
                                    ${qrCode.analytics.tickets_30d}
                                </p>
                            </div>
                            <!-- Sparkline visual -->
                            <div class="hidden lg:flex items-end gap-0.5 h-8 w-12 pb-1">
                                ${generateSparkline(qrCode.analytics.trend)}
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="hidden md:flex col-span-2 md:py-4 items-center">
                        ${getStatusBadge(qrCode.is_active)}
                    </div>

                    <!-- Actions -->
                    <div class="col-span-2 md:pr-6 md:py-4 flex justify-end items-center gap-2 mt-4 md:mt-0 border-t border-gray-100 md:border-0 pt-3 md:pt-0">
                        <button
                            onclick="viewQRCode('${qrCode.id}')"
                            class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Lihat QR Code"
                        >
                            <span class="material-symbols-outlined">visibility</span>
                        </button>
                        <button
                            onclick="printQRCode('${qrCode.id}')"
                            class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                            title="Cetak QR Code"
                        >
                            <span class="material-symbols-outlined">print</span>
                        </button>
                        <button
                            onclick="toggleQRStatus('${qrCode.id}', ${qrCode.is_active})"
                            class="p-2 rounded-lg transition-colors ${qrCode.is_active 
                                ? 'text-orange-500 hover:text-orange-600 hover:bg-orange-50' 
                                : 'text-green-500 hover:text-green-600 hover:bg-green-50'}"
                            title="${qrCode.is_active ? 'Nonaktifkan QR Code' : 'Aktifkan QR Code'}"
                        >
                            <span class="material-symbols-outlined">
                                ${qrCode.is_active ? 'toggle_on' : 'toggle_off'}
                            </span>
                        </button>
                        <button
                            onclick="deleteQRCode('${qrCode.id}', '${qrCode.name}')"
                            class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="Hapus QR Code"
                        >
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Action Functions
        async function toggleQRStatus(id, currentStatus) {
            const newStatus = !currentStatus;
            const statusText = newStatus ? 'mengaktifkan' : 'menonaktifkan';
            
            if (confirm(`Apakah Anda yakin ingin ${statusText} QR Code ini?`)) {
                try {
                    await mockAPI.updateQRCode(id, { is_active: newStatus });
                    updateTestStatus(`âœ… QR Code berhasil ${newStatus ? 'diaktifkan' : 'dinonaktifkan'}.`, 'success');
                    renderQRCodes();
                } catch (error) {
                    updateTestStatus(`âŒ Error: ${error.message}`, 'error');
                }
            }
        }

        async function deleteQRCode(id, name) {
            if (confirm(`Apakah Anda yakin ingin menghapus QR Code "${name}"?\n\nPerhatian: QR Code yang sudah digunakan untuk tiket tidak dapat dihapus.`)) {
                try {
                    await mockAPI.deleteQRCode(id);
                    updateTestStatus(`âœ… QR Code "${name}" berhasil dihapus.`, 'success');
                    renderQRCodes();
                } catch (error) {
                    updateTestStatus(`âŒ Error: ${error.message}`, 'error');
                }
            }
        }

        function viewQRCode(id) {
            const qr = qrCodes.find(q => q.id === id);
            updateTestStatus(`ðŸ‘ï¸ Melihat QR Code: ${qr.name}`, 'info');
        }

        function printQRCode(id) {
            const qr = qrCodes.find(q => q.id === id);
            updateTestStatus(`ðŸ–¨ï¸ Mencetak QR Code: ${qr.name}`, 'info');
        }

        // Test Functions
        async function testToggleStatus() {
            updateTestStatus('ðŸ”„ Testing toggle status function...', 'info');
            
            // Test activating inactive QR
            const inactiveQR = qrCodes.find(qr => !qr.is_active);
            if (inactiveQR) {
                await toggleQRStatus(inactiveQR.id, inactiveQR.is_active);
            }
            
            // Test deactivating active QR
            setTimeout(async () => {
                const activeQR = qrCodes.find(qr => qr.is_active);
                if (activeQR) {
                    await toggleQRStatus(activeQR.id, activeQR.is_active);
                }
            }, 1000);
        }

        async function testDeleteFunction() {
            updateTestStatus('ðŸ—‘ï¸ Testing delete function...', 'info');
            
            // Try to delete QR with high usage (should fail)
            const highUsageQR = qrCodes.find(qr => qr.usage_count > 30);
            if (highUsageQR) {
                await deleteQRCode(highUsageQR.id, highUsageQR.name);
            }
            
            // Try to delete QR with low usage (should succeed)
            setTimeout(async () => {
                const lowUsageQR = qrCodes.find(qr => qr.usage_count <= 30);
                if (lowUsageQR) {
                    await deleteQRCode(lowUsageQR.id, lowUsageQR.name);
                }
            }, 2000);
        }

        async function testCreateQR() {
            updateTestStatus('âž• Testing create QR function...', 'info');
            
            try {
                const newQRData = {
                    name: 'QR Test Baru',
                    unit_id: 'test-unit-id',
                    description: 'QR Code untuk testing'
                };
                
                await mockAPI.createQRCode(newQRData);
                updateTestStatus('âœ… QR Code baru berhasil dibuat.', 'success');
                renderQRCodes();
            } catch (error) {
                updateTestStatus(`âŒ Error creating QR: ${error.message}`, 'error');
            }
        }

        function updateTestStatus(message, type = 'info') {
            const statusElement = document.getElementById('testStatus');
            const colors = {
                info: 'text-blue-700',
                success: 'text-green-700',
                error: 'text-red-700'
            };
            
            statusElement.className = colors[type] || colors.info;
            statusElement.textContent = message;
            
            // Add to test results
            const resultsContainer = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `p-3 rounded border ${
                type === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
                type === 'error' ? 'bg-red-50 border-red-200 text-red-800' :
                'bg-blue-50 border-blue-200 text-blue-800'
            }`;
            resultDiv.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            resultsContainer.appendChild(resultDiv);
            
            // Keep only last 10 results
            const results = resultsContainer.children;
            if (results.length > 11) { // 10 + 1 for the status div
                resultsContainer.removeChild(results[1]); // Keep the first status div
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderQRCodes();
            updateTestStatus('âœ… QR Management interface loaded successfully. Ready for testing!', 'success');
        });
    </script>
</body>
</html>